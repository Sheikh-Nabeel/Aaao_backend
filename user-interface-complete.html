<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üë§ User Interface - Real-Time Booking System</title>
    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%); min-height: 100vh; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; color: white; margin-bottom: 30px; }
        .card { background: white; border-radius: 15px; padding: 25px; margin: 20px 0; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .status-card { background: linear-gradient(45deg, #ff6b6b, #ee5a24); color: white; }
        .status-card.online { background: linear-gradient(45deg, #00d2d3, #54a0ff); }
        .input-group { margin: 15px 0; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        input, select, textarea { width: 100%; padding: 12px; border: 2px solid #e1e8ed; border-radius: 8px; font-size: 14px; transition: border-color 0.3s; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #74b9ff; }
        button { padding: 12px 25px; margin: 8px; background: #74b9ff; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        button:hover { background: #0984e3; transform: translateY(-2px); }
        button:disabled { background: #cbd5e0; cursor: not-allowed; transform: none; }
        button.success { background: #00b894; }
        button.danger { background: #e17055; }
        button.warning { background: #fdcb6e; color: #2d3436; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .full-width { grid-column: 1 / -1; }
        .log { background: #f7fafc; border: 2px solid #e2e8f0; padding: 20px; height: 350px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 13px; border-radius: 8px; }
        .error { color: #e53e3e; font-weight: bold; }
        .success { color: #38a169; font-weight: bold; }
        .info { color: #3182ce; }
        .warning { color: #d69e2e; }
        .timestamp { color: #718096; font-size: 11px; }
        .booking-status { background: #fff5f5; border: 2px solid #feb2b2; padding: 15px; margin: 10px 0; border-radius: 8px; }
        .booking-status.active { background: #f0fff4; border-color: #9ae6b4; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
        .driver-info { background: #edf2f7; padding: 15px; border-radius: 8px; margin: 10px 0; }
        .location-input { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0; }
        .fare-display { background: #e6fffa; border: 2px solid #81e6d9; padding: 15px; border-radius: 8px; text-align: center; font-size: 18px; font-weight: bold; }
        .ride-progress { background: #fff5f5; border-left: 4px solid #74b9ff; padding: 15px; margin: 10px 0; }
        .special-preferences { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; border: 2px solid #e9ecef; }
        .special-preferences h4 { color: #495057; margin-bottom: 15px; }
        input[type="checkbox"] { margin-right: 8px; transform: scale(1.2); }
        label { display: flex; align-items: center; cursor: pointer; }
        label:hover { background: #f1f3f4; padding: 5px; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üë§ User Interface</h1>
            <p>Real-Time Booking System - User Dashboard</p>
        </div>

        <!-- Connection Status -->
        <div class="card status-card" id="statusCard">
            <h2>üîå Connection Status</h2>
            <p id="connectionStatus">Disconnected</p>
            <div class="input-group">
                <label for="userToken">User JWT Token:</label>
                <input type="text" id="userToken" placeholder="Enter user JWT token" value="">
            </div>
            <button onclick="connectSocket()">üîå Connect</button>
            <button onclick="disconnectSocket()">‚ùå Disconnect</button>
        </div>

        <div class="grid">
            <!-- Location Management -->
            <div class="card">
                <h2>üìç Location Management</h2>
                <div class="location-input">
                    <div class="input-group">
                        <label for="pickupLat">Pickup Latitude:</label>
                        <input type="number" id="pickupLat" step="any" value="24.8607" placeholder="24.8607">
                    </div>
                    <div class="input-group">
                        <label for="pickupLng">Pickup Longitude:</label>
                        <input type="number" id="pickupLng" step="any" value="67.0011" placeholder="67.0011">
                    </div>
                    <div class="input-group">
                        <label for="dropoffLat">Dropoff Latitude:</label>
                        <input type="number" id="dropoffLat" step="any" value="24.8615" placeholder="24.8615">
                    </div>
                    <div class="input-group">
                        <label for="dropoffLng">Dropoff Longitude:</label>
                        <input type="number" id="dropoffLng" step="any" value="67.0025" placeholder="67.0025">
                    </div>
                    <button onclick="updateLocation()">üìç Update Location</button>
                </div>
            </div>

            <!-- Booking Management -->
            <div class="card">
                <h2>üöó Booking Management</h2>
                <div class="input-group">
                    <label for="serviceType">Service Type:</label>
                    <select id="serviceType">
                        <option value="bike">üèçÔ∏è Bike</option>
                        <option value="rickshaw">üõ∫ Rickshaw</option>
                        <option value="car">üöó Car</option>
                        <option value="mini">üöô Mini</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="fareAmount">Fare Amount (PKR):</label>
                    <input type="number" id="fareAmount" value="150" placeholder="150">
                </div>
                <div class="input-group">
                    <label for="pickupAddress">Pickup Address:</label>
                    <input type="text" id="pickupAddress" value="Karachi, Pakistan" placeholder="Pickup location">
                </div>
                <div class="input-group">
                    <label for="dropoffAddress">Dropoff Address:</label>
                    <input type="text" id="dropoffAddress" value="Clifton, Karachi" placeholder="Dropoff location">
                </div>
                
                <!-- Special Preferences -->
                <div class="special-preferences">
                    <h4>üéØ Special Preferences:</h4>
                    <div class="input-group">
                        <label>
                            <input type="checkbox" id="requestPinkCaptain" onchange="togglePinkCaptainOptions()"> üíñ Request Pink Captain (Female Driver)
                        </label>
                    </div>
                    <div class="pink-captain-user-options" id="pinkCaptainUserOptions" style="display: none; margin-left: 20px; padding: 10px; border-left: 3px solid #ff69b4; background-color: #fdf2f8;">
                        <p style="margin: 0 0 10px 0; font-size: 12px; color: #666;">Select your Pink Captain preferences:</p>
                        <div class="input-group">
                            <label>
                                <input type="checkbox" id="femalePassengersOnly"> üë© Female Passengers Only
                            </label>
                            <small style="display: block; color: #666; margin-left: 20px;">Only female passengers in the vehicle</small>
                        </div>
                        <div class="input-group">
                            <label>
                                <input type="checkbox" id="familyRides"> üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family Ride
                            </label>
                            <small style="display: block; color: #666; margin-left: 20px;">Family trip with children</small>
                        </div>
                        <div class="input-group">
                            <label>
                                <input type="checkbox" id="safeZoneRides"> üõ°Ô∏è Safe Zone Ride
                            </label>
                            <small style="display: block; color: #666; margin-left: 20px;">Travel within designated safe areas</small>
                        </div>
                    </div>
                    <div class="input-group">
                        <label>
                            <input type="checkbox" id="requestFavoriteDriver"> ‚≠ê Request Favorite Driver
                        </label>
                    </div>
                    <div class="input-group">
                        <label>
                            <input type="checkbox" id="requestNearbyDriver"> üìç Request Nearby Driver Only
                        </label>
                    </div>
                </div>
                
                <button onclick="createBooking()" class="success">üöó Create Booking</button>
                <button onclick="cancelBooking()" class="danger">‚ùå Cancel Booking</button>
            </div>
        </div>

        <div class="grid">
            <!-- Fare Management -->
            <div class="card">
                <h2>üí∞ Fare Management</h2>
                <div class="input-group">
                    <label for="newFare">New Fare Amount:</label>
                    <input type="number" id="newFare" placeholder="200">
                </div>
                <button onclick="adjustFare()" class="warning">üí∞ Adjust Fare</button>
                <button onclick="acceptFareIncrease()" class="success">‚úÖ Accept Fare Increase</button>
                
                <div class="fare-display" id="fareDisplay">
                    Current Fare: PKR 0
                </div>
            </div>

            <!-- Communication -->
            <div class="card">
                <h2>üí¨ Communication</h2>
                <div class="input-group">
                    <label for="messageText">Message:</label>
                    <textarea id="messageText" rows="3" placeholder="Type your message to driver..."></textarea>
                </div>
                <button onclick="sendMessage()">üí¨ Send Message</button>
            </div>
        </div>

        <div class="grid">
            <!-- Rating & Feedback -->
            <div class="card">
                <h2>‚≠ê Rating & Feedback</h2>
                <div class="input-group">
                    <label for="ratingValue">Rating (1-5 stars):</label>
                    <select id="ratingValue">
                        <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5 stars)</option>
                        <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (4 stars)</option>
                        <option value="3">‚≠ê‚≠ê‚≠ê (3 stars)</option>
                        <option value="2">‚≠ê‚≠ê (2 stars)</option>
                        <option value="1">‚≠ê (1 star)</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="reviewText">Review:</label>
                    <textarea id="reviewText" rows="3" placeholder="Write your review..."></textarea>
                </div>
                <button onclick="submitRating()">‚≠ê Submit Rating</button>
            </div>

            <!-- Booking Status -->
            <div class="card">
                <h2>üìä Booking Status</h2>
                <div class="booking-status" id="bookingStatus">
                    <p><strong>Status:</strong> No active booking</p>
                    <p><strong>Booking ID:</strong> -</p>
                    <p><strong>Driver:</strong> -</p>
                    <p><strong>Fare:</strong> PKR 0</p>
                </div>
                
                <div class="driver-info" id="driverInfo" style="display: none;">
                    <h4>üë®‚Äç‚úàÔ∏è Driver Information</h4>
                    <p><strong>Name:</strong> <span id="driverName">-</span></p>
                    <p><strong>Phone:</strong> <span id="driverPhone">-</span></p>
                    <p><strong>Vehicle:</strong> <span id="driverVehicle">-</span></p>
                    <p><strong>Rating:</strong> <span id="driverRating">-</span></p>
                </div>
            </div>
        </div>

        <!-- Real-time Event Log -->
        <div class="card full-width">
            <h2>üìã Real-time Event Log</h2>
            <div class="log" id="eventLog"></div>
            <button onclick="clearLog()">üóëÔ∏è Clear Log</button>
        </div>
    </div>

    <script>
        let socket = null;
        let currentBookingId = null;
        let currentDriverId = null;

        // Socket Connection Functions
        function connectSocket() {
            const token = document.getElementById('userToken').value;
            if (!token) {
                logEvent('‚ùå Please enter a JWT token', 'error');
                return;
            }

            socket = io('http://localhost:3001', {
                auth: { token: token },
                transports: ['websocket', 'polling']
            });

            socket.on('connect', () => {
                logEvent('‚úÖ Connected to server', 'success');
                updateConnectionStatus(true);
                joinUserRoom();
            });

            socket.on('disconnect', () => {
                logEvent('‚ùå Disconnected from server', 'error');
                updateConnectionStatus(false);
            });

            socket.on('connect_error', (error) => {
                logEvent(`‚ùå Connection error: ${error.message}`, 'error');
                updateConnectionStatus(false);
            });

            // Booking Events
            socket.on('booking_created', (data) => {
                logEvent(`üöó Booking created: ${data.bookingId}`, 'success');
                currentBookingId = data.bookingId;
                updateBookingStatus('pending', data.bookingId, null, data.fare);
            });

            socket.on('driver_found', (data) => {
                logEvent(`üë®‚Äç‚úàÔ∏è Driver found: ${data.driver.name}`, 'info');
                currentDriverId = data.driver._id;
                updateDriverInfo(data.driver);
            });

            socket.on('booking_accepted', (data) => {
                logEvent(`‚úÖ Booking accepted by driver`, 'success');
                updateBookingStatus('accepted', data.bookingId, data.driver, data.fare);
            });

            socket.on('booking_rejected', (data) => {
                logEvent(`‚ùå Booking rejected: ${data.reason}`, 'warning');
            });

            socket.on('ride_started', (data) => {
                logEvent(`üöÄ Ride started`, 'success');
                updateBookingStatus('in_progress', data.bookingId, data.driver, data.fare);
            });

            socket.on('ride_completed', (data) => {
                logEvent(`üèÅ Ride completed`, 'success');
                updateBookingStatus('completed', data.bookingId, data.driver, data.fare);
            });

            socket.on('fare_increase_proposed', (data) => {
                logEvent(`üí∞ Driver proposed fare increase: PKR ${data.raisedFare}`, 'warning');
                updateFareDisplay(data.raisedFare);
            });

            socket.on('fare_updated', (data) => {
                logEvent(`üí∞ Fare updated to: PKR ${data.newFare}`, 'info');
                updateFareDisplay(data.newFare);
            });

            socket.on('location_update', (data) => {
                logEvent(`üìç Driver location: ${data.latitude}, ${data.longitude}`, 'info');
            });

            socket.on('message_received', (data) => {
                logEvent(`üí¨ Message from driver: ${data.message}`, 'info');
            });

            socket.on('rating_submitted', (data) => {
                logEvent(`‚≠ê Rating submitted: ${data.rating} stars`, 'success');
            });

            socket.on('error', (data) => {
                logEvent(`‚ùå Error: ${data.message}`, 'error');
            });
        }

        function disconnectSocket() {
            if (socket) {
                socket.disconnect();
                socket = null;
                updateConnectionStatus(false);
                logEvent('‚ùå Disconnected from server', 'warning');
            }
        }

        function joinUserRoom() {
            if (socket) {
                socket.emit('join_user_room');
                logEvent('üè† Joined user room', 'info');
            }
        }

        // UI Functions
        function togglePinkCaptainOptions() {
            const checkbox = document.getElementById('requestPinkCaptain');
            const options = document.getElementById('pinkCaptainUserOptions');
            
            if (checkbox.checked) {
                options.style.display = 'block';
            } else {
                options.style.display = 'none';
                // Clear all Pink Captain options when unchecked
                document.getElementById('femalePassengersOnly').checked = false;
                document.getElementById('familyRides').checked = false;
                document.getElementById('safeZoneRides').checked = false;
            }
        }

        // Booking Functions
        function createBooking() {
            if (!socket) {
                logEvent('‚ùå Not connected to server', 'error');
                return;
            }

            const bookingData = {
                serviceType: document.getElementById('serviceType').value,
                pickupLocation: {
                    latitude: parseFloat(document.getElementById('pickupLat').value),
                    longitude: parseFloat(document.getElementById('pickupLng').value),
                    address: document.getElementById('pickupAddress').value
                },
                dropoffLocation: {
                    latitude: parseFloat(document.getElementById('dropoffLat').value),
                    longitude: parseFloat(document.getElementById('dropoffLng').value),
                    address: document.getElementById('dropoffAddress').value
                },
                fare: parseFloat(document.getElementById('fareAmount').value),
                driverPreference: document.getElementById('requestPinkCaptain').checked ? 'pink_captain' : 'any',
                pinkCaptainOptions: {
                    femalePassengersOnly: document.getElementById('femalePassengersOnly').checked,
                    familyRides: document.getElementById('familyRides').checked,
                    safeZoneRides: document.getElementById('safeZoneRides').checked
                },
                preferences: {
                    requestPinkCaptain: document.getElementById('requestPinkCaptain').checked,
                    requestFavoriteDriver: document.getElementById('requestFavoriteDriver').checked,
                    requestNearbyDriver: document.getElementById('requestNearbyDriver').checked
                }
            };

            socket.emit('create_booking', bookingData);
            logEvent('üöó Creating booking with preferences...', 'info');
            
            if (bookingData.preferences.requestPinkCaptain) {
                logEvent('üíñ Requesting Pink Captain (Female Driver)', 'info');
                if (bookingData.pinkCaptainOptions.femalePassengersOnly) {
                    logEvent('üë© Female Passengers Only preference selected', 'info');
                }
                if (bookingData.pinkCaptainOptions.familyRides) {
                    logEvent('üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family Ride preference selected', 'info');
                }
                if (bookingData.pinkCaptainOptions.safeZoneRides) {
                    logEvent('üõ°Ô∏è Safe Zone Ride preference selected', 'info');
                }
            }
            if (bookingData.preferences.requestFavoriteDriver) {
                logEvent('‚≠ê Requesting Favorite Driver', 'info');
            }
            if (bookingData.preferences.requestNearbyDriver) {
                logEvent('üìç Requesting Nearby Driver Only', 'info');
            }
        }

        function cancelBooking() {
            if (!socket || !currentBookingId) {
                logEvent('‚ùå No active booking to cancel', 'error');
                return;
            }

            socket.emit('cancel_booking', { bookingId: currentBookingId });
            logEvent('‚ùå Cancelling booking...', 'warning');
            currentBookingId = null;
            currentDriverId = null;
            updateBookingStatus('cancelled', null, null, 0);
        }

        // Location Functions
        function updateLocation() {
            if (!socket) {
                logEvent('‚ùå Not connected to server', 'error');
                return;
            }

            const locationData = {
                latitude: parseFloat(document.getElementById('pickupLat').value),
                longitude: parseFloat(document.getElementById('pickupLng').value)
            };

            socket.emit('update_location', locationData);
            logEvent(`üìç Location updated: ${locationData.latitude}, ${locationData.longitude}`, 'info');
        }

        // Fare Functions
        function adjustFare() {
            if (!socket || !currentBookingId) {
                logEvent('‚ùå No active booking', 'error');
                return;
            }

            const newFare = parseFloat(document.getElementById('newFare').value);
            if (!newFare) {
                logEvent('‚ùå Please enter a valid fare amount', 'error');
                return;
            }

            socket.emit('adjust_fare', {
                bookingId: currentBookingId,
                newFare: newFare
            });
            logEvent(`üí∞ Adjusting fare to PKR ${newFare}...`, 'info');
        }

        function acceptFareIncrease() {
            if (!socket || !currentBookingId) {
                logEvent('‚ùå No active booking', 'error');
                return;
            }

            socket.emit('accept_fare_increase', { bookingId: currentBookingId });
            logEvent('‚úÖ Accepting fare increase...', 'success');
        }

        // Communication Functions
        function sendMessage() {
            if (!socket || !currentDriverId) {
                logEvent('‚ùå No driver to message', 'error');
                return;
            }

            const message = document.getElementById('messageText').value;
            if (!message.trim()) {
                logEvent('‚ùå Please enter a message', 'error');
                return;
            }

            socket.emit('send_message', {
                recipientId: currentDriverId,
                message: message
            });
            logEvent(`üí¨ Message sent: ${message}`, 'success');
            document.getElementById('messageText').value = '';
        }

        // Rating Functions
        function submitRating() {
            if (!socket || !currentBookingId) {
                logEvent('‚ùå No completed booking to rate', 'error');
                return;
            }

            const rating = parseInt(document.getElementById('ratingValue').value);
            const review = document.getElementById('reviewText').value;

            socket.emit('submit_rating', {
                bookingId: currentBookingId,
                driverId: currentDriverId,
                rating: rating,
                review: review
            });
            logEvent(`‚≠ê Rating submitted: ${rating} stars`, 'success');
        }

        // UI Update Functions
        function updateConnectionStatus(connected) {
            const statusCard = document.getElementById('statusCard');
            const statusText = document.getElementById('connectionStatus');
            
            if (connected) {
                statusCard.classList.add('online');
                statusText.textContent = 'Connected';
            } else {
                statusCard.classList.remove('online');
                statusText.textContent = 'Disconnected';
            }
        }

        function updateBookingStatus(status, bookingId, driver, fare) {
            const bookingStatus = document.getElementById('bookingStatus');
            const driverInfo = document.getElementById('driverInfo');
            
            bookingStatus.innerHTML = `
                <p><strong>Status:</strong> ${status}</p>
                <p><strong>Booking ID:</strong> ${bookingId || '-'}</p>
                <p><strong>Driver:</strong> ${driver ? driver.name : '-'}</p>
                <p><strong>Fare:</strong> PKR ${fare || 0}</p>
            `;
            
            if (status === 'accepted' || status === 'in_progress') {
                bookingStatus.classList.add('active');
            } else {
                bookingStatus.classList.remove('active');
            }
            
            if (driver) {
                driverInfo.style.display = 'block';
                updateDriverInfo(driver);
            } else {
                driverInfo.style.display = 'none';
            }
        }

        function updateDriverInfo(driver) {
            document.getElementById('driverName').textContent = driver.name || '-';
            document.getElementById('driverPhone').textContent = driver.phone || '-';
            document.getElementById('driverVehicle').textContent = driver.vehicle ? `${driver.vehicle.make} ${driver.vehicle.model}` : '-';
            document.getElementById('driverRating').textContent = driver.rating ? `${driver.rating}/5` : '-';
        }

        function updateFareDisplay(fare) {
            document.getElementById('fareDisplay').textContent = `Current Fare: PKR ${fare}`;
        }

        function logEvent(message, type = 'info') {
            const log = document.getElementById('eventLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;
            log.appendChild(logEntry);
            log.scrollTop = log.scrollHeight;
        }

        function clearLog() {
            document.getElementById('eventLog').innerHTML = '';
        }

        // Initialize
        window.onload = function() {
            logEvent('üë§ User Interface loaded', 'info');
        };
    </script>
</body>
</html>