<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aaao API Testing Interface</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .auth-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .auth-section h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .auth-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .auth-form {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #e1e5e9;
        }

        .auth-form h4 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .user-status {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .user-status h4 {
            margin-bottom: 10px;
            color: #155724;
        }

        .user-status p {
            margin: 5px 0;
        }

        .manual-token-section {
            opacity: 0.7;
        }

        .manual-token-section h4 {
            color: #666;
            font-size: 0.9rem;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .input-group input, .input-group select, .input-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .input-group input:focus, .input-group select:focus, .input-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            color: #333;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            color: #333;
        }

        .test-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 25px;
            border-left: 5px solid #667eea;
        }

        .test-section h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .response-area {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
            white-space: pre-wrap;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-success { background: #48bb78; }
        .status-error { background: #f56565; }
        .status-pending { background: #ed8936; }

        .flow-step {
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
        }

        .flow-step.active {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .flow-step.completed {
            border-color: #48bb78;
            background: #f0fff4;
        }

        .step-number {
            position: absolute;
            top: -10px;
            left: 20px;
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }

        .step-number.completed {
            background: #48bb78;
        }

        .fare-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin: 15px 0;
        }

        .fare-display h4 {
            margin-bottom: 5px;
        }

        .fare-amount {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .adjustment-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
        }

        .adjustment-controls input {
            width: 100px;
            text-align: center;
        }

        /* Socket.IO Styles */
        .socket-section {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .socket-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .socket-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .socket-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .socket-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .socket-status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .events-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            background: white;
        }

        .socket-event {
            border-bottom: 1px solid #eee;
            padding: 10px 0;
            margin-bottom: 10px;
        }

        .socket-event:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .event-time {
            font-size: 0.8rem;
            color: #6c757d;
        }

        .event-data {
             background: #f8f9fa;
             padding: 8px;
             border-radius: 4px;
             font-size: 0.85rem;
             max-height: 150px;
             overflow-y: auto;
         }

         .booking-buttons {
             display: flex;
             gap: 15px;
             margin: 15px 0;
         }

         .booking-buttons .btn {
             flex: 1;
         }

         .socket-testing {
             margin: 15px 0;
             padding: 15px;
             background: #fff;
             border: 1px solid #dee2e6;
             border-radius: 5px;
         }

         .test-controls {
             display: flex;
             gap: 10px;
             flex-wrap: wrap;
         }

         .btn-small {
             padding: 8px 12px;
             font-size: 0.85rem;
         }

         @media (max-width: 768px) {
             .booking-buttons {
                 flex-direction: column;
             }
             
             .test-controls {
                 flex-direction: column;
             }
         }

         @media (max-width: 768px) {
            .form-row, .form-row-3 {
                grid-template-columns: 1fr;
            }
            
            .container {
                margin: 10px;
            }
            
            .content {
                padding: 20px;
            }
        }
        
        /* Booking Management Styles */
        .booking-status {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        
        .fare-negotiation {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #fff3cd;
            border-radius: 5px;
            border: 1px solid #ffeaa7;
        }
        
        .negotiation-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .booking-tips {
            padding: 15px;
            background-color: #d1ecf1;
            border-radius: 5px;
            border: 1px solid #bee5eb;
        }
        
        .booking-tips ul {
            margin: 10px 0 0 0;
            padding-left: 20px;
        }
        
        .booking-tips li {
            margin-bottom: 5px;
            color: #0c5460;
        }
        
        .help-text {
            color: #6c757d;
            font-style: italic;
            margin-bottom: 10px;
        }
        
        .btn-success {
            background-color: #28a745;
            border-color: #28a745;
        }
        
        .btn-warning {
            background-color: #ffc107;
            border-color: #ffc107;
            color: #212529;
        }
        
        .btn-danger {
            background-color: #dc3545;
            border-color: #dc3545;
        }
        
        .btn-success:hover {
            background-color: #218838;
            border-color: #1e7e34;
        }
        
        .btn-warning:hover {
            background-color: #e0a800;
            border-color: #d39e00;
        }
        
        .btn-danger:hover {
            background-color: #c82333;
            border-color: #bd2130;
        }
        
        /* Enhanced animations for fare updates */
        @keyframes highlight {
            0% { background-color: #fff3cd; transform: scale(1); }
            50% { background-color: #ffeaa7; transform: scale(1.02); }
            100% { background-color: #d4edda; transform: scale(1); }
        }
        
        @keyframes slideIn {
            0% { 
                transform: translateX(100%);
                opacity: 0;
            }
            100% { 
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            0% { 
                transform: translateX(0);
                opacity: 1;
            }
            100% { 
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        /* Enhanced response item styling */
        .response-item.success {
            border-left-color: #28a745 !important;
            background-color: #d4edda !important;
        }
        
        .response-item.error {
            border-left-color: #dc3545 !important;
            background-color: #f8d7da !important;
        }
        
        .response-item.info {
            border-left-color: #17a2b8 !important;
            background-color: #d1ecf1 !important;
        }
        
        /* Fare amount highlighting */
        .fare-amount {
            font-weight: bold;
            color: #28a745;
            transition: all 0.3s ease;
        }
        
        .fare-amount.updated {
            animation: pulse 1s ease-in-out;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöó Aaao API Testing Interface</h1>
            <p>Complete Flow Testing: Fare Estimation ‚Üí Price Adjustment ‚Üí Booking Request</p>
        </div>

        <div class="content">
            <!-- User Authentication Section -->
            <div class="auth-section">
                <h3>üîê User Authentication</h3>
                
                <!-- Login/Register Toggle -->
                <div class="auth-toggle">
                    <button class="btn" id="loginTab" onclick="showLogin()" style="background: #667eea;">Login</button>
                    <button class="btn btn-secondary" id="registerTab" onclick="showRegister()">Register</button>
                </div>
                
                <!-- Login Form -->
                <div id="loginForm" class="auth-form">
                    <h4>Login to Your Account</h4>
                    <div class="input-group">
                        <label for="loginEmail">Email:</label>
                        <input type="email" id="loginEmail" placeholder="Enter your email">
                    </div>
                    <div class="input-group">
                        <label for="loginPassword">Password:</label>
                        <input type="password" id="loginPassword" placeholder="Enter your password">
                    </div>
                    <button class="btn" onclick="loginUser()">Login</button>
                </div>
                
                <!-- Register Form -->
                <div id="registerForm" class="auth-form" style="display: none;">
                    <h4>Create New Account</h4>
                    <div class="form-row">
                        <div class="input-group">
                            <label for="registerFirstName">First Name:</label>
                            <input type="text" id="registerFirstName" placeholder="First name">
                        </div>
                        <div class="input-group">
                            <label for="registerLastName">Last Name:</label>
                            <input type="text" id="registerLastName" placeholder="Last name">
                        </div>
                    </div>
                    <div class="input-group">
                        <label for="registerEmail">Email:</label>
                        <input type="email" id="registerEmail" placeholder="Enter your email">
                    </div>
                    <div class="input-group">
                        <label for="registerPassword">Password:</label>
                        <input type="password" id="registerPassword" placeholder="Enter your password">
                    </div>
                    <div class="input-group">
                        <label for="registerPhone">Phone:</label>
                        <input type="tel" id="registerPhone" placeholder="Enter your phone number">
                    </div>
                    <div class="form-row">
                        <div class="input-group">
                            <label for="registerUserType">User Type:</label>
                            <select id="registerUserType">
                                <option value="user">User (Passenger)</option>
                                <option value="driver">Driver</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="registerGender">Gender:</label>
                            <select id="registerGender">
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn" onclick="registerUser()">Register</button>
                </div>
                
                <!-- Current User Status -->
                <div id="userStatus" class="user-status" style="display: none;">
                    <h4>‚úÖ Logged In</h4>
                    <p><strong>Email:</strong> <span id="currentUserEmail"></span></p>
                    <p><strong>Type:</strong> <span id="currentUserType"></span></p>
                    <button class="btn btn-danger" onclick="logoutUser()">Logout</button>
                </div>
                
                <span id="authStatus"></span>
                
                <!-- Manual JWT Token Section (for testing) -->
                <div class="manual-token-section" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e1e5e9;">
                    <h4>üîß Manual Token (For Testing)</h4>
                    <div class="input-group">
                        <label for="jwtToken">JWT Token:</label>
                        <input type="text" id="jwtToken" placeholder="Enter JWT token manually...">
                    </div>
                    <button class="btn btn-secondary" onclick="setAuthToken()">Set Manual Token</button>
                </div>
            </div>

            <!-- Socket.IO Section -->
            <div class="socket-section">
                <h3>üîå Socket.IO Real-time Connection</h3>
                <div class="socket-controls">
                    <button class="btn" onclick="connectAsUser()">üë§ Connect as User</button>
                    <button class="btn" onclick="connectAsDriver()">üöó Connect as Driver</button>
                    <button class="btn btn-secondary" onclick="disconnectSocket()">Disconnect</button>
                    <span id="socketStatus" class="socket-status">Not Connected</span>
                </div>
                <div class="connection-info">
                    <p><strong>Note:</strong> Users send booking requests, Drivers receive and respond to requests</p>
                </div>
                
                <div id="userRoleInfo" class="user-role-info" style="margin-top: 10px; padding: 10px; background-color: #f8f9fa; border-radius: 5px; display: none;">
                    <strong>Account Info:</strong>
                    <div>Database Role: <span id="actualRole">-</span></div>
                    <div>Connection Mode: <span id="connectionMode">-</span></div>
                    <div>KYC Level: <span id="kycLevel">-</span></div>
                </div>
                
                <!-- Socket.IO Testing Controls -->
                <div class="socket-testing">
                    <h4>üß™ Socket.IO Testing:</h4>
                    <div class="test-controls">
                        <button class="btn btn-small" onclick="testSocketAuth()">Test Authentication</button>
                        <button class="btn btn-small" onclick="testDriverLocation()">Simulate Driver Location</button>
                        <button class="btn btn-small" onclick="testBookingUpdate()">Simulate Booking Update</button>
                        <button class="btn btn-small" onclick="clearSocketEvents()">Clear Events</button>
                    </div>
                </div>
                
                <div class="socket-events">
                    <h4>Real-time Events:</h4>
                    <div id="socketEvents" class="events-container"></div>
                </div>
            </div>

            <!-- Real-time Response Display Section -->
            <div class="response-display-section">
                <h3>üìä Real-time Response Monitor</h3>
                <div class="response-controls">
                    <button class="btn btn-small" onclick="clearResponseDisplay()">Clear Responses</button>
                    <button class="btn btn-small" onclick="getBookingStatus()">Check Booking Status</button>
                    <button class="btn btn-small" onclick="getFareHistory()">Get Fare History</button>
                </div>
                
                <div class="response-display">
                    <h4>Latest Responses:</h4>
                    <div id="responseDisplay" class="response-container"></div>
                </div>
                
                <div class="api-testing">
                    <h4>üîó REST API Testing:</h4>
                    <div class="api-controls">
                        <div class="input-group">
                            <label for="testBookingId">Booking ID for Testing:</label>
                            <input type="text" id="testBookingId" placeholder="Enter booking ID...">
                        </div>
                        <div class="test-controls">
                            <button class="btn btn-small" onclick="testGetBookingAPI()">GET Booking Details</button>
                            <button class="btn btn-small" onclick="testUpdateFareAPI()">PUT Update Fare</button>
                            <button class="btn btn-small" onclick="testGetFareHistoryAPI()">GET Fare History</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 1: Fare Estimation -->
            <div class="flow-step active" id="step1">
                <div class="step-number">1</div>
                <div class="test-section">
                    <h3>üí∞ Step 1: Fare Estimation</h3>
                    
                    <div class="form-row">
                        <div class="input-group">
                            <label for="serviceType">Service Type:</label>
                            <select id="serviceType" onchange="updateVehicleTypes()">
                                <option value="car cab">Car Cab</option>
                                <option value="bike">Bike</option>
                                <option value="shifting & movers">Shifting & Movers</option>
                                <option value="car recovery">Car Recovery</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="vehicleType">Vehicle Type:</label>
                            <select id="vehicleType">
                                <option value="economy">Economy</option>
                                <option value="premium">Premium</option>
                                <option value="xl">XL</option>
                                <option value="luxury">Luxury</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="input-group">
                            <label for="pickupAddress">Pickup Address:</label>
                            <input type="text" id="pickupAddress" value="Dubai Mall, Downtown Dubai">
                        </div>
                        <div class="input-group">
                            <label for="dropoffAddress">Dropoff Address:</label>
                            <input type="text" id="dropoffAddress" value="Dubai International Airport">
                        </div>
                    </div>

                    <div class="form-row-3">
                        <div class="input-group">
                            <label for="pickupLat">Pickup Latitude:</label>
                            <input type="number" id="pickupLat" value="25.2048" step="0.0001">
                        </div>
                        <div class="input-group">
                            <label for="pickupLon">Pickup Longitude:</label>
                            <input type="number" id="pickupLon" value="55.2708" step="0.0001">
                        </div>
                        <div class="input-group">
                            <label for="distanceInMeters">Distance (meters):</label>
                            <input type="number" id="distanceInMeters" value="15000">
                        </div>
                    </div>

                    <div class="form-row-3">
                        <div class="input-group">
                            <label for="dropoffLat">Dropoff Latitude:</label>
                            <input type="number" id="dropoffLat" value="25.0657" step="0.0001">
                        </div>
                        <div class="input-group">
                            <label for="dropoffLon">Dropoff Longitude:</label>
                            <input type="number" id="dropoffLon" value="55.1394" step="0.0001">
                        </div>
                        <div class="input-group">
                            <label for="routeType">Route Type:</label>
                            <select id="routeType">
                                <option value="one_way">One Way</option>
                                <option value="two_way">Two Way</option>
                            </select>
                        </div>
                    </div>

                    <button class="btn" onclick="estimateFare()">üßÆ Estimate Fare</button>
                    
                    <div id="fareEstimationResult"></div>
                </div>
            </div>

            <!-- Step 2: Fare Adjustment -->
            <div class="flow-step" id="step2">
                <div class="step-number">2</div>
                <div class="test-section">
                    <h3>üìä Step 2: Fare Adjustment</h3>
                    
                    <div id="currentFareDisplay"></div>
                    
                    <div class="adjustment-controls">
                        <label>Adjust Fare:</label>
                        <button class="btn btn-secondary" onclick="adjustFare(-3)">-3%</button>
                        <button class="btn btn-secondary" onclick="adjustFare(-2)">-2%</button>
                        <button class="btn btn-secondary" onclick="adjustFare(-1)">-1%</button>
                        <input type="number" id="customAdjustment" placeholder="Custom %" step="0.1">
                        <button class="btn" onclick="adjustFareCustom()">Apply</button>
                        <button class="btn btn-secondary" onclick="adjustFare(1)">+1%</button>
                        <button class="btn btn-secondary" onclick="adjustFare(2)">+2%</button>
                        <button class="btn btn-secondary" onclick="adjustFare(3)">+3%</button>
                    </div>
                    
                    <div id="fareAdjustmentResult"></div>
                </div>
            </div>

            <!-- Step 3: Booking Request -->
            <div class="flow-step" id="step3">
                <div class="step-number">3</div>
                <div class="test-section">
                    <h3>üì± Step 3: Create Booking Request</h3>
                    
                    <div class="form-row">
                        <div class="input-group">
                            <label for="driverPreference">Driver Preference:</label>
                            <select id="driverPreference">
                                <option value="nearby">Nearby</option>
                                <option value="pinned">Pinned Driver</option>
                                <option value="pink_captain">Pink Captain</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="searchRadius">Search Radius (km):</label>
                            <input type="number" id="searchRadius" value="10" min="1" max="50">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="input-group">
                            <label for="passengerCount">Passenger Count:</label>
                            <input type="number" id="passengerCount" value="1" min="1" max="8">
                        </div>
                        <div class="input-group">
                            <label for="paymentMethod">Payment Method:</label>
                            <select id="paymentMethod">
                                <option value="cash">Cash</option>
                                <option value="card">Card</option>
                                <option value="wallet">Wallet</option>
                            </select>
                        </div>
                    </div>

                    <div class="input-group">
                        <label>
                            <input type="checkbox" id="wheelchairAccessible"> Wheelchair Accessible
                        </label>
                    </div>

                    <div id="finalFareDisplay"></div>
                    
                    <div class="booking-buttons">
                        <button class="btn" onclick="createBooking()">üöÄ Create Booking Request</button>
                        <button class="btn btn-primary" onclick="createBookingWithSocket()">üîå Create Booking with Real-time Updates</button>
                        <button class="btn btn-secondary" onclick="alert('Test button works!')">üß™ Test Button</button>
                        <button class="btn btn-info" onclick="console.log('Functions exist:', typeof createBooking, typeof createBookingWithSocket); alert('Check console for function status')">üîç Check Functions</button>
                    </div>
                    
                    <div id="bookingResult"></div>
                </div>
            </div>

            <!-- Step 4: Active Booking Management -->
            <div class="flow-step" id="step4">
                <div class="step-number">4</div>
                <div class="test-section">
                    <h3>‚ö° Step 4: Active Booking Management</h3>
                    
                    <div class="booking-status">
                        <div class="input-group">
                            <label for="bookingId">Current Booking ID:</label>
                            <input type="text" id="bookingId" readonly placeholder="No active booking">
                        </div>
                        
                        <div id="currentBookingFare"></div>
                    </div>
                    
                    <div class="fare-negotiation">
                        <h4>üí∞ Fare Negotiation</h4>
                        <p class="help-text">Adjust your fare if no drivers are accepting your request</p>
                        
                        <div class="negotiation-buttons">
                            <button class="btn btn-success" onclick="increaseFare()">üìà Increase Fare</button>
                            <button class="btn btn-warning" onclick="decreaseFare()">üìâ Decrease Fare</button>
                            <button class="btn btn-danger" onclick="cancelBookingRequest()">‚ùå Cancel Request</button>
                        </div>
                    </div>
                    
                    <div class="booking-tips">
                        <h4>üí° Tips</h4>
                        <ul>
                            <li>If no drivers accept within 2-3 minutes, try increasing the fare</li>
                            <li>Higher fares attract drivers faster, especially during peak hours</li>
                            <li>You can cancel and create a new request if needed</li>
                            <li>Watch the real-time events below for driver responses</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Step 5: Additional Actions -->
             <div class="flow-step" id="step5">
                 <div class="step-number">5</div>
                <div class="test-section">
                    <h3>‚ö° Step 4: Additional Actions</h3>
                    
                    <div class="form-row">
                        <div class="input-group">
                            <label for="bookingId">Booking ID:</label>
                            <input type="text" id="bookingId" placeholder="Enter booking ID for actions...">
                        </div>
                        <div class="input-group">
                            <label for="newFareAmount">New Fare Amount:</label>
                            <input type="number" id="newFareAmount" placeholder="Enter new fare amount..." step="0.01">
                        </div>
                    </div>

                    <button class="btn" onclick="raiseFare()">üìà Raise Fare</button>
                    <button class="btn btn-secondary" onclick="lowerFare()">üìâ Lower Fare</button>
                    <button class="btn btn-danger" onclick="cancelBooking()">‚ùå Cancel Booking</button>
                    <button class="btn" onclick="getNearbyDrivers()">üîç Get Nearby Drivers</button>
                    
                    <div id="additionalActionsResult"></div>
                </div>
            </div>
            
            <!-- Driver Interface Section -->
            <div class="flow-step" id="driverInterface" style="display: none;">
                <div class="step-number">üöó</div>
                <div class="test-section">
                    <h3>üöó Driver Interface - Incoming Booking Requests</h3>
                    
                    <div class="driver-status">
                        <div class="input-group">
                            <label>Driver Status:</label>
                            <select id="driverStatus" onchange="updateDriverStatus()">
                                <option value="available">üü¢ Available</option>
                                <option value="busy">üî¥ Busy</option>
                                <option value="offline">‚ö´ Offline</option>
                            </select>
                        </div>
                        
                        <div class="input-group">
                            <label for="driverLocation">Current Location:</label>
                            <input type="text" id="driverLocation" placeholder="Enter your current location...">
                        </div>
                    </div>
                    
                    <div class="incoming-requests">
                        <h4>üì• Incoming Booking Requests</h4>
                        <div id="incomingRequestsList">
                            <p class="help-text">No incoming requests. Connect as driver to receive booking requests.</p>
                        </div>
                    </div>
                    
                    <div class="driver-actions">
                        <h4>üéØ Driver Actions</h4>
                        <div class="form-row">
                            <div class="input-group">
                                <label for="requestIdToRespond">Request ID:</label>
                                <input type="text" id="requestIdToRespond" placeholder="Enter request ID...">
                            </div>
                            <div class="input-group">
                                <label for="counterOfferFare">Counter Offer Fare:</label>
                                <input type="number" id="counterOfferFare" placeholder="Enter fare amount..." step="0.01">
                            </div>
                        </div>
                        
                        <div class="negotiation-buttons">
                            <button class="btn btn-success" onclick="acceptBookingRequest()">‚úÖ Accept Request</button>
                            <button class="btn btn-warning" onclick="counterOfferFare()">üí∞ Counter Offer</button>
                            <button class="btn btn-danger" onclick="rejectBookingRequest()">‚ùå Reject Request</button>
                        </div>
                    </div>
                    
                    <div class="driver-tips">
                        <h4>üí° Driver Tips</h4>
                        <ul>
                            <li>Keep your status updated to receive relevant requests</li>
                            <li>Respond quickly to booking requests to increase acceptance rate</li>
                            <li>Use counter offers if the initial fare is too low</li>
                            <li>Update your location regularly for better matching</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:3001/api';
        let authToken = '';
        let currentFare = 0;
        let currentServiceType = 'car cab';
        let currentBookingId = '';

        // Vehicle type options for different services
        const vehicleOptions = {
            'car cab': ['economy', 'premium', 'xl', 'family', 'luxury'],
            'bike': ['standard'],
            'shifting & movers': ['mini pickup', 'suzuki carry', 'small van', 'medium truck', 'mazda', 'covered van', 'large truck', '6-wheeler', 'container truck'],
            'car recovery': ['flatbed towing', 'wheel lift towing', 'on-road winching', 'off-road winching', 'battery jump start', 'fuel delivery', 'luxury & exotic car recovery', 'heavy-duty vehicle recovery']
        };

        // Authentication form switching
        function showLogin() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('loginTab').style.background = '#667eea';
            document.getElementById('loginTab').classList.remove('btn-secondary');
            document.getElementById('registerTab').style.background = '';
            document.getElementById('registerTab').classList.add('btn-secondary');
        }

        function showRegister() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
            document.getElementById('registerTab').style.background = '#667eea';
            document.getElementById('registerTab').classList.remove('btn-secondary');
            document.getElementById('loginTab').style.background = '';
            document.getElementById('loginTab').classList.add('btn-secondary');
        }

        // User registration
        async function registerUser() {
            const firstName = document.getElementById('registerFirstName').value.trim();
            const lastName = document.getElementById('registerLastName').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;
            const phone = document.getElementById('registerPhone').value.trim();
            const userType = document.getElementById('registerUserType').value;
            const gender = document.getElementById('registerGender').value;

            if (!firstName || !lastName || !email || !password || !phone) {
                document.getElementById('authStatus').innerHTML = '<span class="status-indicator status-error"></span>Please fill all required fields';
                return;
            }

            const userData = {
                firstName,
                lastName,
                email,
                password,
                phone,
                userType,
                gender
            };

            try {
                const response = await fetch(`${API_BASE_URL}/user/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });

                const result = await response.json();

                if (response.ok) {
                    authToken = result.token;
                    localStorage.setItem('authToken', authToken);
                    document.getElementById('authStatus').innerHTML = '<span class="status-indicator status-success"></span>Registration successful!';
                    showUserStatus(result.user || { email, userType });
                } else {
                    document.getElementById('authStatus').innerHTML = `<span class="status-indicator status-error"></span>Registration failed: ${result.message || 'Unknown error'}`;
                }
            } catch (error) {
                document.getElementById('authStatus').innerHTML = `<span class="status-indicator status-error"></span>Registration error: ${error.message}`;
            }
        }

        // User login
        async function loginUser() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                document.getElementById('authStatus').innerHTML = '<span class="status-indicator status-error"></span>Please enter email and password';
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/user/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });

                const result = await response.json();
                console.log('Login response:', result);
                console.log('result.userId:', result.userId);
                console.log('result.user:', result.user);

                if (response.ok) {
                    authToken = result.token;
                    localStorage.setItem('authToken', authToken);
                    
                    // Store user data for Socket.IO room joining
                    const userData = result.user || { email, userType: result.userType || 'user' };
                    userData.id = result.userId; // Ensure user ID is always present
                    userData.role = userData.userType || userData.role || 'user';
                    console.log('userData before storing:', userData);
                    localStorage.setItem('currentUser', JSON.stringify(userData));
                    console.log('Stored in localStorage:', JSON.parse(localStorage.getItem('currentUser')));
                    
                    document.getElementById('authStatus').innerHTML = '<span class="status-indicator status-success"></span>Login successful!';
                    showUserStatus(userData);
                    
                    // Automatically connect to Socket.IO after successful login
                    connectSocket();
                } else {
                    document.getElementById('authStatus').innerHTML = `<span class="status-indicator status-error"></span>Login failed: ${result.message || 'Invalid credentials'}`;
                }
            } catch (error) {
                document.getElementById('authStatus').innerHTML = `<span class="status-indicator status-error"></span>Login error: ${error.message}`;
            }
        }

        // Show user status after successful login/register
        function showUserStatus(user) {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('userStatus').style.display = 'block';
            document.getElementById('currentUserEmail').textContent = user.email;
            document.getElementById('currentUserType').textContent = user.userType || 'user';
        }

        // User logout
        function logoutUser() {
            authToken = '';
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            
            // Disconnect from Socket.IO
            disconnectSocket();
            
            document.getElementById('userStatus').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('authStatus').innerHTML = '<span class="status-indicator status-success"></span>Logged out successfully';
            
            // Clear form fields
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('registerFirstName').value = '';
            document.getElementById('registerLastName').value = '';
            document.getElementById('registerEmail').value = '';
            document.getElementById('registerPassword').value = '';
            document.getElementById('registerPhone').value = '';
            
            // Disconnect socket if connected
            if (isSocketConnected) {
                disconnectSocket();
            }
        }

        // Manual token setting (for testing)
        function setAuthToken() {
            authToken = document.getElementById('jwtToken').value.trim();
            if (authToken) {
                // Store token in localStorage for Socket.IO connection
                localStorage.setItem('authToken', authToken);
                document.getElementById('authStatus').innerHTML = '<span class="status-indicator status-success"></span>Manual Token Set Successfully';
                console.log('Manual token stored in localStorage:', authToken);
            } else {
                document.getElementById('authStatus').innerHTML = '<span class="status-indicator status-error"></span>Please enter a valid token';
            }
        }

        function updateVehicleTypes() {
            const serviceType = document.getElementById('serviceType').value;
            const vehicleTypeSelect = document.getElementById('vehicleType');
            
            vehicleTypeSelect.innerHTML = '';
            vehicleOptions[serviceType].forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option.charAt(0).toUpperCase() + option.slice(1);
                vehicleTypeSelect.appendChild(optionElement);
            });
        }

        async function makeRequest(endpoint, method = 'GET', data = null) {
            const config = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                }
            };

            if (data) {
                config.body = JSON.stringify(data);
            }

            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, config);
                const result = await response.json();
                return { success: response.ok, data: result, status: response.status };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        function displayResponse(elementId, response) {
            const element = document.getElementById(elementId);
            const responseArea = document.createElement('div');
            responseArea.className = 'response-area';
            
            if (response.success) {
                responseArea.innerHTML = `<span class="status-indicator status-success"></span>Success\n${JSON.stringify(response.data, null, 2)}`;
            } else {
                responseArea.innerHTML = `<span class="status-indicator status-error"></span>Error\n${JSON.stringify(response.error || response.data, null, 2)}`;
            }
            
            element.innerHTML = '';
            element.appendChild(responseArea);
        }

        async function estimateFare() {
            if (!authToken) {
                alert('Please set your JWT token first');
                return;
            }

            const serviceType = document.getElementById('serviceType').value;
            const vehicleType = document.getElementById('vehicleType').value;
            const pickupLat = parseFloat(document.getElementById('pickupLat').value);
            const pickupLon = parseFloat(document.getElementById('pickupLon').value);
            const dropoffLat = parseFloat(document.getElementById('dropoffLat').value);
            const dropoffLon = parseFloat(document.getElementById('dropoffLon').value);
            const pickupAddress = document.getElementById('pickupAddress').value;
            const dropoffAddress = document.getElementById('dropoffAddress').value;
            const distanceInMeters = parseInt(document.getElementById('distanceInMeters').value);
            const routeType = document.getElementById('routeType').value;

            const requestData = {
                pickupLocation: {
                    coordinates: [pickupLon, pickupLat],
                    address: pickupAddress
                },
                dropoffLocation: {
                    coordinates: [dropoffLon, dropoffLat],
                    address: dropoffAddress
                },
                serviceType,
                vehicleType,
                routeType,
                distanceInMeters,
                paymentMethod: 'cash'
            };

            // Add service-specific data
            if (serviceType === 'shifting & movers') {
                requestData.serviceDetails = {
                    shiftingMovers: {
                        selectedServices: {
                            loadingUnloading: true,
                            packing: false
                        },
                        floorDetails: {
                            pickupFloor: 1,
                            dropoffFloor: 1,
                            hasElevator: true
                        }
                    }
                };
                requestData.itemDetails = [{
                    category: 'furniture',
                    name: 'sofa',
                    quantity: 1,
                    weight: 50
                }];
            } else if (serviceType === 'car recovery') {
                requestData.serviceCategory = vehicleType;
                requestData.serviceDetails = {
                    carRecovery: {
                        vehicleInfo: {
                            make: 'Toyota',
                            model: 'Camry',
                            year: 2020,
                            condition: 'not_starting'
                        },
                        recoveryType: 'towing',
                        urgency: 'normal'
                    }
                };
            }

            const response = await makeRequest('/fare/estimate-fare', 'POST', requestData);
            displayResponse('fareEstimationResult', response);

            if (response.success && response.data.data) {
                currentFare = response.data.data.estimatedFare;
                currentServiceType = serviceType;
                
                // Update fare display
                document.getElementById('currentFareDisplay').innerHTML = `
                    <div class="fare-display">
                        <h4>Current Estimated Fare</h4>
                        <div class="fare-amount">${currentFare} AED</div>
                        <small>Range: ${response.data.data.adjustmentSettings.minFare} - ${response.data.data.adjustmentSettings.maxFare} AED</small>
                    </div>
                `;
                
                // Mark step 1 as completed and activate step 2
                document.getElementById('step1').classList.add('completed');
                document.getElementById('step1').classList.remove('active');
                document.getElementById('step2').classList.add('active');
                document.querySelector('#step1 .step-number').classList.add('completed');
            }
        }

        async function adjustFare(percentage) {
            if (!currentFare) {
                alert('Please estimate fare first');
                return;
            }

            const adjustedFare = currentFare * (1 + percentage / 100);
            await validateFareAdjustment(currentFare, adjustedFare);
        }

        async function adjustFareCustom() {
            const customPercentage = parseFloat(document.getElementById('customAdjustment').value);
            if (isNaN(customPercentage)) {
                alert('Please enter a valid percentage');
                return;
            }
            await adjustFare(customPercentage);
        }

        async function validateFareAdjustment(originalFare, adjustedFare) {
            const requestData = {
                originalFare,
                adjustedFare,
                serviceType: currentServiceType
            };

            const response = await makeRequest('/fare/adjust-fare', 'POST', requestData);
            displayResponse('fareAdjustmentResult', response);

            if (response.success) {
                currentFare = adjustedFare;
                
                // Update final fare display
                document.getElementById('finalFareDisplay').innerHTML = `
                    <div class="fare-display">
                        <h4>Final Adjusted Fare</h4>
                        <div class="fare-amount">${adjustedFare.toFixed(2)} AED</div>
                        <small>Adjustment: ${response.data.data.adjustmentPercentage}%</small>
                    </div>
                `;
                
                // Mark step 2 as completed and activate step 3
                document.getElementById('step2').classList.add('completed');
                document.getElementById('step2').classList.remove('active');
                document.getElementById('step3').classList.add('active');
                document.querySelector('#step2 .step-number').classList.add('completed');
            }
        }

        async function createBooking() {
            alert('Create Booking button clicked!');
            console.log('=== CREATE BOOKING FUNCTION CALLED ===');
            console.log('Current fare:', currentFare);
            console.log('Auth token:', authToken);
            
            if (!currentFare) {
                alert('Please estimate and adjust fare first');
                return;
            }
            
            if (!authToken) {
                alert('Please log in first to create a booking');
                return;
            }

            const serviceType = document.getElementById('serviceType').value;
            const vehicleType = document.getElementById('vehicleType').value;
            const pickupLat = parseFloat(document.getElementById('pickupLat').value);
            const pickupLon = parseFloat(document.getElementById('pickupLon').value);
            const dropoffLat = parseFloat(document.getElementById('dropoffLat').value);
            const dropoffLon = parseFloat(document.getElementById('dropoffLon').value);
            const pickupAddress = document.getElementById('pickupAddress').value;
            const dropoffAddress = document.getElementById('dropoffAddress').value;
            const distanceInMeters = parseInt(document.getElementById('distanceInMeters').value);
            const routeType = document.getElementById('routeType').value;
            const driverPreference = document.getElementById('driverPreference').value;
            const searchRadius = parseInt(document.getElementById('searchRadius').value);
            const passengerCount = parseInt(document.getElementById('passengerCount').value);
            const paymentMethod = document.getElementById('paymentMethod').value;
            const wheelchairAccessible = document.getElementById('wheelchairAccessible').checked;

            const requestData = {
                pickupLocation: {
                    coordinates: [pickupLon, pickupLat],
                    address: pickupAddress
                },
                dropoffLocation: {
                    coordinates: [dropoffLon, dropoffLat],
                    address: dropoffAddress
                },
                serviceType,
                vehicleType,
                routeType,
                distanceInMeters,
                offeredFare: currentFare,
                driverPreference,
                passengerCount,
                wheelchairAccessible,
                driverFilters: {
                    searchRadius
                },
                paymentMethod
            };

            // Add service-specific data
            if (serviceType === 'shifting & movers') {
                requestData.furnitureDetails = {
                    sofas: 1,
                    boxes: 5,
                    other: 'TV stand'
                };
                requestData.serviceDetails = {
                    shiftingMovers: {
                        selectedServices: {
                            loadingUnloading: true,
                            packing: false
                        },
                        floorDetails: {
                            pickupFloor: 1,
                            dropoffFloor: 1,
                            hasElevator: true
                        }
                    }
                };
                requestData.itemDetails = [{
                    category: 'furniture',
                    name: 'sofa',
                    quantity: 1,
                    weight: 50
                }];
            } else if (serviceType === 'car recovery') {
                requestData.serviceCategory = vehicleType;
                requestData.serviceDetails = {
                    carRecovery: {
                        vehicleInfo: {
                            make: 'Toyota',
                            model: 'Camry',
                            year: 2020,
                            condition: 'not_starting'
                        },
                        recoveryType: 'towing',
                        urgency: 'normal'
                    }
                };
            }

            console.log('=== SENDING BOOKING REQUEST ===');
            console.log('Request data:', JSON.stringify(requestData, null, 2));
            console.log('API endpoint:', '/bookings/create-booking');
            
            const response = await makeRequest('/bookings/create-booking', 'POST', requestData);
            console.log('=== BOOKING RESPONSE RECEIVED ===');
            console.log('Response:', response);
            
            displayResponse('bookingResult', response);

            if (response.success && response.data.data) {
                currentBookingId = response.data.data.bookingId;
                document.getElementById('bookingId').value = currentBookingId;
                
                // Mark step 3 as completed and activate step 4
                document.getElementById('step3').classList.add('completed');
                document.getElementById('step3').classList.remove('active');
                document.getElementById('step4').classList.add('active');
                document.querySelector('#step3 .step-number').classList.add('completed');
            }
        }

        async function raiseFare() {
            const bookingId = document.getElementById('bookingId').value;
            const newFare = parseFloat(document.getElementById('newFareAmount').value);
            
            if (!bookingId || !newFare) {
                alert('Please enter booking ID and new fare amount');
                return;
            }

            const response = await makeRequest(`/bookings/raise-fare/${bookingId}`, 'POST', {
                newFare,
                reason: 'User requested fare increase'
            });
            displayResponse('additionalActionsResult', response);
        }

        async function lowerFare() {
            const bookingId = document.getElementById('bookingId').value;
            const newFare = parseFloat(document.getElementById('newFareAmount').value);
            
            if (!bookingId || !newFare) {
                alert('Please enter booking ID and new fare amount');
                return;
            }

            const response = await makeRequest(`/bookings/lower-fare/${bookingId}`, 'POST', {
                newFare,
                reason: 'User requested fare decrease'
            });
            displayResponse('additionalActionsResult', response);
        }

        async function cancelBooking() {
            const bookingId = document.getElementById('bookingId').value;
            
            if (!bookingId) {
                alert('Please enter booking ID');
                return;
            }

            const response = await makeRequest('/bookings/cancel-booking', 'POST', {
                bookingId,
                reason: 'User cancelled'
            });
            displayResponse('additionalActionsResult', response);
        }

        async function getNearbyDrivers() {
            const lat = document.getElementById('pickupLat').value;
            const lon = document.getElementById('pickupLon').value;
            const serviceType = document.getElementById('serviceType').value;
            const searchRadius = document.getElementById('searchRadius').value;

            const response = await makeRequest(`/bookings/nearby-drivers?lat=${lat}&lon=${lon}&serviceType=${encodeURIComponent(serviceType)}&searchRadius=${searchRadius}`);
            displayResponse('additionalActionsResult', response);
        }

        // Socket.IO Integration
        let socket = null;
        let isSocketConnected = false;

        function initializeSocket() {
            console.log('initializeSocket() called');
            const token = localStorage.getItem('authToken');
            console.log('Token in initializeSocket:', token ? token.substring(0, 20) + '...' : 'null');
            
            if (!token) {
                console.log('No auth token found for Socket.IO connection');
                updateSocketStatus('No Token Found', 'error');
                return;
            }

            console.log('Initializing Socket.IO connection to http://localhost:3001');
            console.log('Socket.io function available:', typeof io);
            
            socket = io('http://localhost:3001', {
                auth: {
                    token: token
                },
                timeout: 10000
            });
            
            console.log('Socket object created:', socket);

            socket.on('connect', () => {
                console.log('Socket.IO connected:', socket.id);
                isSocketConnected = true;
                updateSocketStatus('Connected', 'success');
                
                // Automatically join appropriate room based on user role
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                if (currentUser.id && currentUser.role) {
                    if (currentUser.role === 'driver') {
                        socket.emit('join_driver_room', currentUser.id);
                        console.log('Joining driver room for user:', currentUser.id);
                    } else {
                        socket.emit('join_user_room', currentUser.id);
                        console.log('Joining user room for user:', currentUser.id);
                    }
                }
            });

            socket.on('disconnect', () => {
                console.log('Socket.IO disconnected');
                isSocketConnected = false;
                updateSocketStatus('Disconnected', 'error');
            });

            socket.on('connect_error', (error) => {
                console.error('Socket.IO connection error:', error);
                isSocketConnected = false;
                if (error.message.includes('timeout')) {
                    updateSocketStatus('Connection Timeout - Check Server', 'error');
                } else if (error.message.includes('unauthorized')) {
                    updateSocketStatus('Authentication Failed', 'error');
                } else {
                    updateSocketStatus('Connection Error: ' + error.message, 'error');
                }
            });

            socket.on('connect_timeout', () => {
                console.error('Socket.IO connection timeout');
                isSocketConnected = false;
                updateSocketStatus('Connection Timeout', 'error');
            });

            // Enhanced booking-related socket events
            socket.on('booking_request_created', (data) => {
                console.log('Booking request created:', data);
                currentBookingId = data.requestId;
                document.getElementById('bookingId').value = currentBookingId;
                
                // Display comprehensive booking information
                displaySocketEvent('Booking Request Created', {
                    requestId: data.requestId,
                    driversFound: data.driversFound,
                    message: data.message,
                    fare: data.fare,
                    serviceType: data.serviceType,
                    vehicleType: data.vehicleType,
                    distance: data.distance,
                    status: data.status
                });
                
                // Display detailed booking information in real-time monitor
                displayRealTimeResponse('üöó Socket.IO: Booking Request Created', {
                    requestId: data.requestId,
                    message: data.message,
                    fare: data.fare,
                    offeredFare: data.offeredFare,
                    distance: data.distance,
                    distanceInMeters: data.distanceInMeters,
                    serviceType: data.serviceType,
                    vehicleType: data.vehicleType,
                    serviceCategory: data.serviceCategory,
                    routeType: data.routeType,
                    driverPreference: data.driverPreference,
                    passengerCount: data.passengerCount,
                    paymentMethod: data.paymentMethod,
                    status: data.status,
                    driversFound: data.driversFound,
                    pickupLocation: data.from ? {
                        address: data.from.address,
                        zone: data.from.zone
                    } : null,
                    dropoffLocation: data.to ? {
                        address: data.to.address,
                        zone: data.to.zone
                    } : null,
                    user: data.user ? {
                        name: `${data.user.firstName || ''} ${data.user.lastName || ''}`.trim(),
                        email: data.user.email,
                        phoneNumber: data.user.phoneNumber,
                        kycLevel: data.user.kycLevel,
                        isVerified: data.user.isVerified
                    } : null,
                    fareCalculation: data.fareCalculation,
                    serviceDetails: data.serviceDetails,
                    appointmentDetails: data.appointmentDetails,
                    itemDetails: data.itemDetails,
                    success: true,
                    timestamp: new Date().toISOString()
                }, 'success');
                
                // Update booking result display with comprehensive information
                const bookingResult = document.getElementById('bookingResult');
                if (bookingResult) {
                    bookingResult.innerHTML = `
                        <div class="alert alert-success" style="margin: 10px 0; padding: 15px; border-radius: 8px;">
                            <h5 style="margin: 0 0 15px 0;">üöó Booking Request Created Successfully!</h5>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">
                                <div><strong>üìã Booking ID:</strong> ${data.requestId}</div>
                                <div><strong>üí∞ Fare:</strong> ${data.fare || 'N/A'} AED</div>
                                <div><strong>üöó Service:</strong> ${data.serviceType || 'N/A'}</div>
                                <div><strong>üöô Vehicle:</strong> ${data.vehicleType || 'N/A'}</div>
                                <div><strong>üìè Distance:</strong> ${data.distance || 'N/A'} km</div>
                                <div><strong>üë• Passengers:</strong> ${data.passengerCount || 1}</div>
                                <div><strong>üí≥ Payment:</strong> ${data.paymentMethod || 'cash'}</div>
                                <div><strong>üìä Status:</strong> ${data.status || 'pending'}</div>
                                <div><strong>üöó Drivers Found:</strong> ${data.driversFound || 0}</div>
                                <div><strong>üéØ Preference:</strong> ${data.driverPreference || 'nearby'}</div>
                            </div>
                            ${data.from && data.to ? `
                                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #dee2e6;">
                                    <div style="margin-bottom: 8px;"><strong>üìç From:</strong> ${data.from.address} (${data.from.zone})</div>
                                    <div><strong>üìç To:</strong> ${data.to.address} (${data.to.zone})</div>
                                </div>
                            ` : ''}
                            ${data.user ? `
                                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #dee2e6;">
                                    <div style="margin-bottom: 8px;"><strong>üë§ User:</strong> ${data.user.firstName || ''} ${data.user.lastName || ''}</div>
                                    <div style="margin-bottom: 8px;"><strong>üìß Email:</strong> ${data.user.email}</div>
                                    <div><strong>üì± Phone:</strong> ${data.user.phoneNumber}</div>
                                </div>
                            ` : ''}
                            ${data.message ? `<div style="margin-top: 15px;"><strong>üìù Message:</strong> ${data.message}</div>` : ''}
                        </div>
                    `;
                    
                    // Add visual highlight animation
                    bookingResult.style.animation = 'slideIn 0.5s ease-out';
                }
                
                // Enhanced notification with comprehensive details
                alert(`üöó Booking Request Created Successfully!\n\n` +
                      `üìã Booking ID: ${data.requestId}\n` +
                      `üí∞ Fare: ${data.fare || 'N/A'} AED\n` +
                      `üöó Service: ${data.serviceType || 'N/A'}\n` +
                      `üöô Vehicle: ${data.vehicleType || 'N/A'}\n` +
                      `üìè Distance: ${data.distance || 'N/A'} km\n` +
                      `üöó Drivers Found: ${data.driversFound || 0}\n` +
                      `üìä Status: ${data.status || 'pending'}\n` +
                      `${data.message ? `üìù Message: ${data.message}` : ''}`);
            });

            socket.on('booking_request_accepted', (data) => {
                console.log('Booking accepted by driver:', data);
                displaySocketEvent('Booking Accepted', {
                    requestId: data.requestId,
                    driver: data.driver,
                    message: 'Your booking has been accepted!',
                    acceptedAt: data.acceptedAt
                });
            });

            socket.on('booking_request_unavailable', (data) => {
                console.log('Booking no longer available:', data);
                displaySocketEvent('Booking Unavailable', data);
            });

            socket.on('fare_raised', (data) => {
                console.log('Fare raised successfully:', data);
                displaySocketEvent('Fare Increased', {
                    requestId: data.requestId,
                    previousFare: data.previousFare,
                    newFare: data.newFare,
                    message: data.message
                });
            });

            socket.on('fare_increased', (data) => {
                console.log('Fare increased successfully:', data);
                
                // Display comprehensive fare increase information matching REST API response
                displaySocketEvent('Fare Increased', {
                    requestId: data.requestId,
                    newFare: data.newFare,
                    previousFare: data.previousFare,
                    raisedFare: data.raisedFare,
                    message: data.message,
                    driversFound: data.driversFound,
                    user: data.user,
                    serviceType: data.serviceType,
                    vehicleType: data.vehicleType,
                    distance: data.distance,
                    from: data.from,
                    to: data.to,
                    paymentMethod: data.paymentMethod,
                    status: data.status,
                    fareNegotiationHistory: data.fareNegotiationHistory,
                    timestamp: data.timestamp || new Date().toISOString()
                });
                
                // Display in real-time response monitor with comprehensive details
                displayRealTimeResponse('üî• Socket.IO: Fare Increased Successfully', {
                    requestId: data.requestId,
                    previousFare: data.previousFare || currentFare,
                    newFare: data.newFare,
                    raisedFare: data.raisedFare,
                    fareIncrease: data.newFare - (data.previousFare || currentFare),
                    driversNotified: data.driversFound,
                    driversFound: data.driversFound,
                    message: data.message,
                    serviceType: data.serviceType,
                    vehicleType: data.vehicleType,
                    distance: data.distance,
                    userInfo: data.user ? `${data.user.firstName} ${data.user.lastName} (${data.user.role})` : 'N/A',
                    tripRoute: data.from && data.to ? `${data.from.address} ‚Üí ${data.to.address}` : 'N/A',
                    paymentMethod: data.paymentMethod,
                    bookingStatus: data.status,
                    negotiationCount: data.fareNegotiationHistory ? data.fareNegotiationHistory.length : 0,
                    status: 'Updated',
                    success: true,
                    timestamp: data.timestamp || new Date().toISOString()
                }, 'success');
                
                // Update current fare display with comprehensive formatting
                if (data.newFare) {
                    const fareResult = document.getElementById('fareResult');
                    if (fareResult) {
                        const increaseAmount = data.newFare - (data.previousFare || currentFare);
                        fareResult.innerHTML = `
                            <div class="alert alert-success" style="margin: 10px 0; padding: 15px; border-radius: 8px;">
                                <h5 style="margin: 0 0 10px 0;">‚úÖ Fare Updated Successfully!</h5>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">
                                    <div><strong>üìã Booking ID:</strong> ${data.requestId}</div>
                                    <div><strong>üí∞ New Fare:</strong> ${data.newFare} AED</div>
                                    <div><strong>üí∞ Previous Fare:</strong> ${data.previousFare || currentFare} AED</div>
                                    <div><strong>üìà Increase:</strong> +${increaseAmount.toFixed(2)} AED</div>
                                    <div><strong>üöó Drivers Notified:</strong> ${data.driversFound || 0}</div>
                                    <div><strong>üìä Status:</strong> ${data.status || 'Updated'}</div>
                                    ${data.serviceType ? `<div><strong>üöô Service:</strong> ${data.serviceType}</div>` : ''}
                                    ${data.vehicleType ? `<div><strong>üöó Vehicle:</strong> ${data.vehicleType}</div>` : ''}
                                    ${data.distance ? `<div><strong>üìè Distance:</strong> ${data.distance} km</div>` : ''}
                                    ${data.paymentMethod ? `<div><strong>üí≥ Payment:</strong> ${data.paymentMethod}</div>` : ''}
                                    ${data.user ? `<div><strong>üë§ User:</strong> ${data.user.firstName} ${data.user.lastName}</div>` : ''}
                                    ${data.fareNegotiationHistory ? `<div><strong>üîÑ Negotiations:</strong> ${data.fareNegotiationHistory.length}</div>` : ''}
                                </div>
                                ${data.from && data.to ? `
                                    <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                                        <strong>üó∫Ô∏è Route:</strong> ${data.from.address} ‚Üí ${data.to.address}
                                    </div>
                                ` : ''}
                                ${data.message ? `<div style="margin-top: 10px;"><strong>üìù Message:</strong> ${data.message}</div>` : ''}
                            </div>
                        `;
                        
                        // Add visual highlight animation
                        fareResult.style.animation = 'highlight 2s ease-in-out';
                    }
                    currentFare = data.newFare;
                }
                
                // Enhanced notification with comprehensive details
                const increaseAmount = data.newFare - (data.previousFare || currentFare);
                alert(`üî• Fare increased successfully!\n\n` +
                      `üìã Booking: ${data.requestId}\n` +
                      `üí∞ New Fare: ${data.newFare} AED\n` +
                      `üìà Increase: +${increaseAmount.toFixed(2)} AED\n` +
                      `üöó Drivers Notified: ${data.driversFound || 0}\n` +
                      `üìä Status: ${data.status || 'Updated'}\n` +
                      `${data.serviceType ? `üöô Service: ${data.serviceType}\n` : ''}` +
                      `${data.distance ? `üìè Distance: ${data.distance} km\n` : ''}` +
                      `${data.user ? `üë§ User: ${data.user.firstName} ${data.user.lastName}\n` : ''}` +
                      `${data.message ? `üìù Message: ${data.message}` : ''}`);
            });
            
            socket.on('fare_increase_error', (data) => {
                console.error('Fare increase error:', data);
                
                // Display comprehensive error information matching REST API error response
                displaySocketEvent('Fare Increase Error', {
                    error: data.message,
                    errorCode: data.error,
                    requestId: data.requestId,
                    currentFare: data.currentFare,
                    providedFare: data.providedFare,
                    status: data.status,
                    details: data.details,
                    timestamp: data.timestamp || new Date().toISOString()
                });
                
                // Display comprehensive error in real-time monitor
                displayRealTimeResponse('‚ùå Socket.IO: Fare Increase Error', {
                    error: data.message,
                    errorCode: data.error,
                    requestId: data.requestId,
                    currentFare: data.currentFare,
                    providedFare: data.providedFare,
                    bookingStatus: data.status,
                    errorDetails: data.details,
                    success: false,
                    timestamp: data.timestamp || new Date().toISOString()
                }, 'error');
                
                // Update fare result with comprehensive error details
                const fareResult = document.getElementById('fareResult');
                if (fareResult) {
                    fareResult.innerHTML = `
                        <div class="alert alert-danger" style="margin: 10px 0; padding: 15px; border-radius: 8px;">
                            <h5 style="margin: 0 0 10px 0;">‚ùå Fare Increase Failed</h5>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">
                                <div><strong>üìù Error:</strong> ${data.message || 'Unknown error occurred'}</div>
                                ${data.error ? `<div><strong>üîç Error Code:</strong> ${data.error}</div>` : ''}
                                ${data.requestId ? `<div><strong>üìã Booking ID:</strong> ${data.requestId}</div>` : ''}
                                ${data.currentFare ? `<div><strong>üí∞ Current Fare:</strong> ${data.currentFare} AED</div>` : ''}
                                ${data.providedFare ? `<div><strong>üí∏ Provided Fare:</strong> ${data.providedFare} AED</div>` : ''}
                                ${data.status ? `<div><strong>üìä Booking Status:</strong> ${data.status}</div>` : ''}
                            </div>
                            ${data.details ? `
                                <div style="margin-top: 10px; padding: 10px; background: #f8d7da; border-radius: 5px;">
                                    <strong>üîç Technical Details:</strong> ${data.details}
                                </div>
                            ` : ''}
                            <div style="margin-top: 10px;"><strong>üí° Suggestion:</strong> Please check your booking status and try again</div>
                        </div>
                    `;
                }
                
                // Enhanced error notification with comprehensive details
                alert(`‚ùå Fare Increase Error:\n\n` +
                      `üìù Error: ${data.message}\n` +
                      `${data.error ? `üîç Error Code: ${data.error}\n` : ''}` +
                      `${data.requestId ? `üìã Booking: ${data.requestId}\n` : ''}` +
                      `${data.currentFare ? `üí∞ Current Fare: ${data.currentFare} AED\n` : ''}` +
                      `${data.providedFare ? `üí∏ Provided Fare: ${data.providedFare} AED\n` : ''}` +
                      `${data.status ? `üìä Status: ${data.status}\n` : ''}` +
                      `${data.details ? `üîç Details: ${data.details}\n` : ''}` +
                      `üí° Please check your booking status and try again.`);
            });
            
            socket.on('booking_fare_updated', (data) => {
                console.log('Booking fare updated notification:', data);
                displaySocketEvent('Booking Fare Updated', {
                    requestId: data.requestId,
                    fare: data.fare,
                    raisedFare: data.raisedFare,
                    serviceType: data.serviceType,
                    timestamp: new Date().toISOString()
                });
                
                // Display detailed fare update in real-time monitor
                displayRealTimeResponse('üí∞ Socket.IO: Booking Fare Updated', {
                    requestId: data.requestId,
                    fare: data.fare,
                    raisedFare: data.raisedFare,
                    serviceType: data.serviceType,
                    status: 'Fare Updated',
                    success: true,
                    timestamp: new Date().toISOString()
                }, 'info');
                
                // Update any existing booking displays with new fare information
                if (data.requestId) {
                    const bookingElements = document.querySelectorAll(`[data-booking-id="${data.requestId}"]`);
                    bookingElements.forEach(element => {
                        const fareElement = element.querySelector('.fare-amount');
                        if (fareElement) {
                            fareElement.textContent = `${data.fare} AED`;
                            fareElement.style.animation = 'highlight 2s ease-in-out';
                        }
                    });
                }
                
                // Show toast notification for fare updates
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(135deg, #28a745, #20c997);
                    color: white;
                    padding: 15px 20px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 1000;
                    max-width: 320px;
                    font-family: Arial, sans-serif;
                    animation: slideIn 0.3s ease-out;
                `;
                notification.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 8px; font-size: 16px;">üí∞ Fare Updated</div>
                    <div style="font-size: 14px; line-height: 1.4;">
                        <div>üìã Booking: ${data.requestId}</div>
                        <div>üí∞ New Fare: ${data.fare} AED</div>
                        ${data.serviceType ? `<div>üöó Service: ${data.serviceType}</div>` : ''}
                    </div>
                `;
                document.body.appendChild(notification);
                
                // Auto-remove notification after 5 seconds
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.style.animation = 'slideOut 0.3s ease-in';
                        setTimeout(() => {
                            if (notification.parentNode) {
                                notification.parentNode.removeChild(notification);
                            }
                        }, 300);
                    }
                }, 5000);
            });

            socket.on('booking_error', (data) => {
                console.error('Booking error:', data);
                displaySocketEvent('Booking Error', {
                    error: data.message,
                    timestamp: new Date().toISOString()
                });
                alert('Booking Error: ' + data.message);
            });

            socket.on('driver_location_update', (data) => {
                console.log('Driver location update:', data);
                displaySocketEvent('Driver Location Update', data);
            });

            socket.on('booking_status_update', (data) => {
                console.log('Booking status update:', data);
                displaySocketEvent('Booking Status Update', data);
            });
            
            // Room joining events
            socket.on('room_joined', (data) => {
                console.log('Successfully joined room:', data);
                displaySocketEvent('Room Joined', data);
            });
            
            socket.on('error', (data) => {
                console.error('Socket error:', data);
                displaySocketEvent('Socket Error', data);
                alert('Socket Error: ' + data.message);
            });
            
            // Driver-specific event listeners
            socket.on('new_booking_request', (data) => {
                console.log('New booking request received:', data);
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                
                // Only show to users connected as drivers who are actually drivers
                if (currentUser.connectionMode === 'driver' && currentUser.role === 'driver') {
                    displayIncomingRequest(data);
                    displaySocketEvent('New Booking Request', {
                        requestId: data.requestId,
                        from: data.pickupLocation.address,
                        to: data.dropoffLocation.address,
                        fare: data.offeredFare,
                        service: data.serviceType
                    });
                    
                    // Optional: Play notification sound or show browser notification
                    if (Notification.permission === 'granted') {
                        new Notification('New Booking Request', {
                            body: `${data.offeredFare} AED - ${data.serviceType}`,
                            icon: '/favicon.ico'
                        });
                    }
                }
            });
            
            socket.on('booking_accepted_by_driver', (data) => {
                console.log('Booking accepted by driver:', data);
                displaySocketEvent('Driver Accepted Booking', data);
            });
            
            socket.on('booking_rejected_by_driver', (data) => {
                console.log('Booking rejected by driver:', data);
                displaySocketEvent('Driver Rejected Booking', data);
            });
            
            socket.on('counter_offer_received', (data) => {
                console.log('Counter offer received:', data);
                displaySocketEvent('Counter Offer Received', {
                    requestId: data.requestId,
                    driverName: data.driverName,
                    originalFare: data.originalFare,
                    counterFare: data.counterFare,
                    message: `Driver ${data.driverName} offered ${data.counterFare} AED`
                });
                
                // Show alert to users connected as users
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                if (currentUser.connectionMode === 'user') {
                    const accept = confirm(`Driver ${data.driverName} offered ${data.counterFare} AED instead of ${data.originalFare} AED. Accept this offer?`);
                    if (accept) {
                        socket.emit('user_counter_offer_response', {
                            requestId: data.requestId,
                            driverId: data.driverId,
                            response: 'accepted'
                        });
                    } else {
                        socket.emit('user_counter_offer_response', {
                            requestId: data.requestId,
                            driverId: data.driverId,
                            response: 'rejected'
                        });
                    }
                }
            });
            
            // Driver response event listeners
            socket.on('driver_response_success', (data) => {
                console.log('Driver response success:', data);
                displaySocketEvent('Driver Response Success', data);
                
                if (data.action === 'accept') {
                    alert(`Booking request ${data.requestId} accepted successfully!`);
                } else if (data.action === 'counter_offer') {
                    alert(`Counter offer of ${data.newFare} AED sent successfully!`);
                } else if (data.action === 'reject') {
                    alert(`Booking request ${data.requestId} rejected successfully!`);
                }
            });
            
            socket.on('driver_response_error', (data) => {
                console.error('Driver response error:', data);
                displaySocketEvent('Driver Response Error', data);
                alert('Error: ' + data.message);
            });
            
            socket.on('booking_accepted', (data) => {
                console.log('Booking accepted:', data);
                displaySocketEvent('Booking Accepted', data);
                
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                if (currentUser.connectionMode === 'user') {
                    alert(`Your booking has been accepted by driver ${data.driver.name}!`);
                }
            });
            
            socket.on('booking_rejected', (data) => {
                console.log('Booking rejected:', data);
                displaySocketEvent('Booking Rejected', data);
            });
            
            socket.on('driver_counter_offer', (data) => {
                console.log('Driver counter offer:', data);
                displaySocketEvent('Driver Counter Offer', data);
                
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                if (currentUser.connectionMode === 'user') {
                    const accept = confirm(`Driver offered ${data.newFare} AED (original: ${data.originalFare} AED). Accept this offer?`);
                    if (accept) {
                        socket.emit('user_counter_offer_response', {
                            requestId: data.requestId,
                            driverId: data.driverId,
                            response: 'accepted'
                        });
                    } else {
                        socket.emit('user_counter_offer_response', {
                            requestId: data.requestId,
                            driverId: data.driverId,
                            response: 'rejected'
                        });
                    }
                }
            });
            
            socket.on('counter_offer_accepted', (data) => {
                console.log('Counter offer accepted:', data);
                displaySocketEvent('Counter Offer Accepted', data);
                
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                if (currentUser.connectionMode === 'driver') {
                    alert(`Your counter offer of ${data.acceptedFare} AED has been accepted! Ride will start soon.`);
                }
            });
            
            socket.on('counter_offer_rejected', (data) => {
                console.log('Counter offer rejected:', data);
                displaySocketEvent('Counter Offer Rejected', data);
                
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                if (currentUser.connectionMode === 'driver') {
                    alert(`Your counter offer has been rejected.`);
                }
            });
            
            socket.on('ride_started', (data) => {
                console.log('Ride started:', data);
                displaySocketEvent('Ride Started', data);
                
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                if (currentUser.connectionMode === 'user') {
                    alert(`üöó Your ride has started! Driver: ${data.driver.name}`);
                    displayRealTimeResponse(`üöó Ride Started: Your ride with driver ${data.driver.name} has begun at ${new Date(data.startedAt).toLocaleTimeString()}`);
                } else if (currentUser.connectionMode === 'driver') {
                    alert(`üöó Ride started! Passenger: ${data.user.name}`);
                    displayRealTimeResponse(`üöó Ride Started: Your ride with passenger ${data.user.name} has begun at ${new Date(data.startedAt).toLocaleTimeString()}`);
                }
            });
            
            socket.on('booking_confirmed', (data) => {
                console.log('Booking confirmed:', data);
                displaySocketEvent('Booking Confirmed', data);
                
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                if (currentUser.connectionMode === 'user') {
                    alert(`‚úÖ Booking confirmed with driver ${data.booking.driver.name} at ${data.booking.fare} AED! Ride will start soon.`);
                    displayRealTimeResponse(`‚úÖ Booking Confirmed: Driver ${data.booking.driver.name} accepted your fare offer of ${data.booking.fare} AED`);
                }
            });
            
            socket.on('fare_offer_accepted', (data) => {
                console.log('Fare offer accepted:', data);
                displaySocketEvent('Fare Offer Accepted', data);
                
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                if (currentUser.connectionMode === 'driver') {
                    alert(`‚úÖ Your fare offer of ${data.booking.fare} AED has been accepted! Ride will start soon.`);
                    displayRealTimeResponse(`‚úÖ Fare Accepted: User accepted your offer of ${data.booking.fare} AED`);
                }
            });
        }

        function updateSocketStatus(status, type) {
            const statusElement = document.getElementById('socketStatus');
            if (statusElement) {
                statusElement.textContent = status;
                statusElement.className = `socket-status ${type}`;
            }
        }

        function displaySocketEvent(eventType, data) {
            const eventsContainer = document.getElementById('socketEvents');
            if (eventsContainer) {
                const eventDiv = document.createElement('div');
                eventDiv.className = 'socket-event';
                eventDiv.innerHTML = `
                    <div class="event-header">
                        <strong>${eventType}</strong>
                        <span class="event-time">${new Date().toLocaleTimeString()}</span>
                    </div>
                    <pre class="event-data">${JSON.stringify(data, null, 2)}</pre>
                `;
                eventsContainer.insertBefore(eventDiv, eventsContainer.firstChild);
                
                // Keep only last 10 events
                while (eventsContainer.children.length > 10) {
                    eventsContainer.removeChild(eventsContainer.lastChild);
                }
            }
        }

        function connectSocket() {
            console.log('connectSocket() called');
            console.log('isSocketConnected:', isSocketConnected);
            
            // Debug localStorage
            console.log('localStorage contents:', localStorage);
            console.log('All localStorage keys:', Object.keys(localStorage));
            
            if (!isSocketConnected) {
                const token = localStorage.getItem('authToken');
                console.log('Token found:', token ? 'Yes' : 'No');
                console.log('Token value:', token);
                
                if (!token) {
                    updateSocketStatus('Authentication Required', 'error');
                    alert('Please set your JWT token first in the Authentication section before connecting to Socket.IO!');
                    return;
                }
                updateSocketStatus('Connecting...', 'warning');
                console.log('Calling initializeSocket()');
                initializeSocket();
            } else {
                console.log('Already connected');
                updateSocketStatus('Already Connected', 'success');
            }
        }

        function connectAsUser() {
            console.log('connectAsUser() called');
            
            // Check if user is authenticated
            const token = localStorage.getItem('authToken');
            if (!token) {
                alert('Please log in first to connect as a user!');
                return;
            }
            
            // Get current user data from localStorage (set during login)
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            
            // Check if user has a valid role
            if (!currentUser.role || !['customer', 'driver', 'admin', 'superadmin'].includes(currentUser.role)) {
                alert('Invalid user role. Please log in again.');
                return;
            }
            
            // Set connection mode to user
            currentUser.connectionMode = 'user';
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            // Hide driver interface
            document.getElementById('driverInterface').style.display = 'none';
            
            // Update role info display
            updateRoleInfoDisplay(currentUser);
            
            // Connect to Socket.IO
            connectSocket();
            
            displaySocketEvent('Connection Mode', {
                mode: 'User',
                description: 'Connected as user - can send booking requests',
                actualRole: currentUser.role,
                timestamp: new Date().toISOString()
            });
        }
        
        function connectAsDriver() {
            console.log('connectAsDriver() called');
            
            // Check if user is authenticated
            const token = localStorage.getItem('authToken');
            if (!token) {
                alert('Please log in first to connect as a driver!');
                return;
            }
            
            // Get current user data from localStorage (set during login)
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            
            // Check if user is actually a driver in the database
            if (currentUser.role !== 'driver') {
                alert(`You cannot connect as a driver because your account role is '${currentUser.role}'. To become a driver, you need to:\n\n1. Complete KYC Level 1 (Upload CNIC and selfie)\n2. Complete KYC Level 2 (Upload driving license)\n3. Register your vehicle\n4. Get admin approval\n\nOnce approved, your role will be changed to 'driver' in the system.`);
                return;
            }
            
            // Set connection mode to driver
            currentUser.connectionMode = 'driver';
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            // Show driver interface
            document.getElementById('driverInterface').style.display = 'block';
            
            // Update role info display
            updateRoleInfoDisplay(currentUser);
            
            // Connect to Socket.IO
            connectSocket();
            
            displaySocketEvent('Connection Mode', {
                mode: 'Driver',
                description: 'Connected as driver - can receive and respond to booking requests',
                actualRole: currentUser.role,
                kycLevel: currentUser.kycLevel,
                timestamp: new Date().toISOString()
            });
        }

        function disconnectSocket() {
            if (socket && isSocketConnected) {
                socket.disconnect();
                socket = null;
                isSocketConnected = false;
                updateSocketStatus('Manually Disconnected', 'warning');
                
                // Hide role info when disconnected
                document.getElementById('userRoleInfo').style.display = 'none';
            }
        }
        
        function updateRoleInfoDisplay(currentUser) {
            const roleInfoDiv = document.getElementById('userRoleInfo');
            const actualRoleSpan = document.getElementById('actualRole');
            const connectionModeSpan = document.getElementById('connectionMode');
            const kycLevelSpan = document.getElementById('kycLevel');
            
            if (roleInfoDiv && actualRoleSpan && connectionModeSpan && kycLevelSpan) {
                actualRoleSpan.textContent = currentUser.role || 'Unknown';
                connectionModeSpan.textContent = currentUser.connectionMode || 'None';
                kycLevelSpan.textContent = currentUser.kycLevel || '0';
                roleInfoDiv.style.display = 'block';
                
                // Add color coding based on role
                actualRoleSpan.style.color = currentUser.role === 'driver' ? '#28a745' : '#007bff';
                connectionModeSpan.style.fontWeight = 'bold';
            }
        }

        // Enhanced booking function with Socket.IO integration
        async function createBookingWithSocket() {
            alert('Create Booking with Socket button clicked!');
            console.log('=== CREATE BOOKING WITH SOCKET FUNCTION CALLED ===');
            console.log('Socket connected:', isSocketConnected);
            console.log('Current fare:', currentFare);
            
            try {
                // Check if user is authenticated
                const token = localStorage.getItem('authToken');
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                console.log('Auth token:', token);
                console.log('Current user:', currentUser);
                
                console.log('Validation check 1: Auth token and user');
                console.log('Token exists:', !!token);
                console.log('Token value:', token ? 'Present' : 'Missing');
                console.log('currentUser._id:', currentUser._id);
                console.log('currentUser.id:', currentUser.id);
                console.log('currentUser keys:', Object.keys(currentUser));
                if (!token || !currentUser.id) {
                    console.log('FAILED: No token or user ID');
                    console.log('Token check:', !token);
                    console.log('User ID check:', !currentUser.id);
                    alert('Please log in first to create a booking request!');
                    return;
                }
                console.log('PASSED: Auth validation');
                
                // Check if socket is connected
                console.log('Validation check 2: Socket connection');
                console.log('isSocketConnected:', isSocketConnected);
                console.log('socket exists:', !!socket);
                if (!isSocketConnected || !socket) {
                    console.log('FAILED: Socket not connected');
                    alert('Please connect to Socket.IO first for real-time booking!');
                    return;
                }
                console.log('PASSED: Socket validation');
                
                // Validate required fields
                console.log('Validation check 3: Location fields');
                const pickupLat = parseFloat(document.getElementById('pickupLat').value);
                const pickupLon = parseFloat(document.getElementById('pickupLon').value);
                const dropoffLat = parseFloat(document.getElementById('dropoffLat').value);
                const dropoffLon = parseFloat(document.getElementById('dropoffLon').value);
                const pickupAddress = document.getElementById('pickupAddress').value;
                const dropoffAddress = document.getElementById('dropoffAddress').value;
                
                console.log('Location values:', {pickupLat, pickupLon, dropoffLat, dropoffLon, pickupAddress, dropoffAddress});
                
                if (!pickupLat || !pickupLon || !dropoffLat || !dropoffLon || !pickupAddress || !dropoffAddress) {
                    console.log('FAILED: Missing location fields');
                    alert('Please fill in all required location fields!');
                    return;
                }
                console.log('PASSED: Location validation');
                
                console.log('Validation check 4: Fare');
                console.log('currentFare:', currentFare);
                if (!currentFare || currentFare <= 0) {
                    console.log('FAILED: No fare calculated');
                    alert('Please calculate fare first!');
                    return;
                }
                console.log('PASSED: Fare validation');

                // Prepare booking data for Socket.IO
                const bookingData = {
                    pickupLocation: {
                        coordinates: [pickupLon, pickupLat],
                        address: pickupAddress
                    },
                    dropoffLocation: {
                        coordinates: [dropoffLon, dropoffLat],
                        address: dropoffAddress
                    },
                    serviceType: document.getElementById('serviceType').value,
                    vehicleType: document.getElementById('vehicleType').value,
                    distanceInMeters: parseFloat(document.getElementById('distanceInMeters').value),
                    offeredFare: currentFare,
                    searchRadius: parseInt(document.getElementById('searchRadius').value) || 5,
                    passengerCount: 1,
                    wheelchairAccessible: document.getElementById('wheelchairAccessible')?.checked || false,
                    paymentMethod: 'cash'
                };

                // Add service-specific data
                const serviceType = document.getElementById('serviceType').value;
                if (serviceType === 'shifting & movers') {
                    const furnitureItemsEl = document.getElementById('furnitureItems');
                    const totalWeightEl = document.getElementById('totalWeight');
                    const specialInstructionsEl = document.getElementById('specialInstructions');
                    
                    if (furnitureItemsEl && totalWeightEl && specialInstructionsEl) {
                        bookingData.furnitureDetails = {
                            items: furnitureItemsEl.value.split(',').map(item => item.trim()),
                            totalWeight: parseFloat(totalWeightEl.value) || 0,
                            specialInstructions: specialInstructionsEl.value
                        };
                    }
                } else if (serviceType === 'car recovery') {
                    const recoveryTypeEl = document.getElementById('recoveryType');
                    const urgencyEl = document.getElementById('urgency');
                    
                    if (recoveryTypeEl && urgencyEl) {
                        bookingData.recoveryDetails = {
                            recoveryType: recoveryTypeEl.value,
                            urgency: urgencyEl.value
                        };
                    }
                }

                // Send booking request via Socket.IO
                socket.emit('new_booking_request', bookingData);
                
                displaySocketEvent('Booking Request Sent', {
                    message: 'Booking request sent to nearby drivers',
                    fare: currentFare,
                    serviceType: bookingData.serviceType,
                    vehicleType: bookingData.vehicleType,
                    timestamp: new Date().toISOString()
                });
                
                displayResponse('bookingResult', {
                    success: true,
                    message: 'Booking request sent via Socket.IO',
                    data: { fare: currentFare, status: 'pending' }
                });
                
            } catch (error) {
                console.error('Error creating booking:', error);
                displayResponse('bookingResult', { success: false, error: error.message });
            }
        }

        // Fare adjustment functions for negotiation
        function increaseFare() {
            if (!currentBookingId) {
                alert('No active booking request to adjust fare for!');
                return;
            }
            
            if (!isSocketConnected || !socket) {
                alert('Please connect to Socket.IO first!');
                return;
            }
            
            const currentFareValue = currentFare || 0;
            const increaseAmount = parseFloat(prompt('Enter amount to increase fare by (AED):', '5.00'));
            
            if (isNaN(increaseAmount) || increaseAmount <= 0) {
                alert('Please enter a valid positive amount!');
                return;
            }
            
            const newFare = currentFareValue + increaseAmount;
            const previousFare = currentFareValue;
            
            // Update current fare
            currentFare = newFare;
            
            // Update fare display - use fareAdjustmentResult or create fareResult if it doesn't exist
            let fareResult = document.getElementById('fareResult');
            if (!fareResult) {
                fareResult = document.getElementById('fareAdjustmentResult');
            }
            
            if (fareResult) {
                fareResult.innerHTML = `
                    <div class="alert alert-info" style="margin: 10px 0; padding: 10px; border-radius: 5px;">
                        <strong>üí∞ Current Fare:</strong> ${newFare.toFixed(2)} AED
                        <small style="display: block; margin-top: 5px;">Fare updated via Socket.IO</small>
                    </div>
                `;
            }
            
            // Send fare increase via Socket.IO
            socket.emit('increase_fare', {
                requestId: currentBookingId,
                newFare: newFare,
                previousFare: previousFare
            });
            
            displaySocketEvent('Fare Increase Sent', {
                requestId: currentBookingId,
                previousFare: previousFare,
                newFare: newFare,
                increase: increaseAmount,
                timestamp: new Date().toISOString()
            });
        }
        
        function decreaseFare() {
            if (!currentBookingId) {
                alert('No active booking request to adjust fare for!');
                return;
            }
            
            if (!isSocketConnected || !socket) {
                alert('Please connect to Socket.IO first!');
                return;
            }
            
            const currentFareValue = currentFare || 0;
            const decreaseAmount = parseFloat(prompt('Enter amount to decrease fare by (AED):', '5.00'));
            
            if (isNaN(decreaseAmount) || decreaseAmount <= 0) {
                alert('Please enter a valid positive amount!');
                return;
            }
            
            const newFare = Math.max(1, currentFareValue - decreaseAmount); // Minimum fare of 1 AED
            const previousFare = currentFareValue;
            
            if (newFare === currentFareValue) {
                alert('Cannot decrease fare below 1 AED!');
                return;
            }
            
            // Update current fare
            currentFare = newFare;
            
            // Update fare display - use fareAdjustmentResult or create fareResult if it doesn't exist
            let fareResult = document.getElementById('fareResult');
            if (!fareResult) {
                fareResult = document.getElementById('fareAdjustmentResult');
            }
            
            if (fareResult) {
                fareResult.innerHTML = `
                    <div class="alert alert-warning" style="margin: 10px 0; padding: 10px; border-radius: 5px;">
                        <strong>üí∞ Current Fare:</strong> ${newFare.toFixed(2)} AED
                        <small style="display: block; margin-top: 5px;">Fare updated via Socket.IO</small>
                    </div>
                `;
            }
            
            // Send fare decrease via Socket.IO (using increase_fare event with lower amount)
            socket.emit('increase_fare', {
                requestId: currentBookingId,
                newFare: newFare,
                previousFare: previousFare
            });
            
            displaySocketEvent('Fare Decrease Sent', {
                requestId: currentBookingId,
                previousFare: previousFare,
                newFare: newFare,
                decrease: decreaseAmount,
                timestamp: new Date().toISOString()
            });
        }
        
        function cancelBookingRequest() {
            if (!currentBookingId) {
                alert('No active booking request to cancel!');
                return;
            }
            
            if (!isSocketConnected || !socket) {
                alert('Please connect to Socket.IO first!');
                return;
            }
            
            const reason = prompt('Enter cancellation reason (optional):', 'Change of plans');
            
            socket.emit('cancel_booking_request', {
                requestId: currentBookingId,
                cancelledBy: 'user',
                reason: reason || 'No reason provided'
            });
            
            displaySocketEvent('Booking Cancelled', {
                requestId: currentBookingId,
                reason: reason,
                timestamp: new Date().toISOString()
            });
            
            // Clear current booking
            currentBookingId = null;
            document.getElementById('bookingId').value = '';
        }

        // Socket.IO Testing Functions
        function testSocketAuth() {
            if (!isSocketConnected) {
                alert('Please connect to Socket.IO first!');
                return;
            }
            
            socket.emit('test_auth', { message: 'Testing authentication' });
            displaySocketEvent('Auth Test', { message: 'Authentication test sent', timestamp: new Date().toISOString() });
        }

        function testDriverLocation() {
            if (!isSocketConnected) {
                alert('Please connect to Socket.IO first!');
                return;
            }
            
            const mockLocation = {
                driverId: 'driver_123',
                latitude: 28.6139 + (Math.random() - 0.5) * 0.01,
                longitude: 77.2090 + (Math.random() - 0.5) * 0.01,
                heading: Math.floor(Math.random() * 360),
                speed: Math.floor(Math.random() * 60)
            };
            
            socket.emit('driver_location_update', mockLocation);
            displaySocketEvent('Driver Location Update', mockLocation);
        }

        function testBookingUpdate() {
            if (!isSocketConnected) {
                alert('Please connect to Socket.IO first!');
                return;
            }
            
            const mockBookingUpdate = {
                bookingId: currentBookingId || 'booking_' + Date.now(),
                status: 'driver_assigned',
                driverInfo: {
                    name: 'Test Driver',
                    phone: '+91 9876543210',
                    vehicleNumber: 'DL 01 AB 1234',
                    rating: 4.8
                },
                estimatedArrival: '5 minutes'
            };
            
            socket.emit('booking_status_update', mockBookingUpdate);
            displaySocketEvent('Booking Status Update', mockBookingUpdate);
        }

        function clearSocketEvents() {
            const eventsContainer = document.getElementById('socketEvents');
            eventsContainer.innerHTML = '<p style="color: #6c757d; font-style: italic;">No events yet...</p>';
        }

        // Driver-specific functions
        function updateDriverStatus() {
            const status = document.getElementById('driverStatus').value;
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            
            if (socket && isSocketConnected) {
                socket.emit('driver_status_update', {
                    driverId: currentUser.id,
                    status: status,
                    timestamp: new Date().toISOString()
                });
                
                displaySocketEvent('Driver Status Update', {
                    status: status,
                    timestamp: new Date().toISOString()
                });
            }
        }
        
        function acceptBookingRequest() {
            const requestId = document.getElementById('requestIdToRespond').value.trim();
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            
            if (!requestId) {
                alert('Please enter a request ID to accept!');
                return;
            }
            
            if (socket && isSocketConnected) {
                socket.emit('driver_response', {
                    requestId: requestId,
                    action: 'accept',
                    driverId: currentUser.id,
                    timestamp: new Date().toISOString()
                });
                
                displaySocketEvent('Booking Request Accepted', {
                    requestId: requestId,
                    action: 'accept',
                    driverId: currentUser.id,
                    timestamp: new Date().toISOString()
                });
                
                // Clear the request ID field
                document.getElementById('requestIdToRespond').value = '';
            } else {
                alert('Please connect to Socket.IO first!');
            }
        }
        
        function counterOfferFare() {
            const requestId = document.getElementById('requestIdToRespond').value.trim();
            const counterFare = parseFloat(document.getElementById('counterOfferFare').value);
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            
            if (!requestId) {
                alert('Please enter a request ID!');
                return;
            }
            
            if (!counterFare || counterFare <= 0) {
                alert('Please enter a valid counter offer fare!');
                return;
            }
            
            if (socket && isSocketConnected) {
                socket.emit('driver_response', {
                    requestId: requestId,
                    action: 'counter_offer',
                    newFare: counterFare,
                    driverId: currentUser.id,
                    timestamp: new Date().toISOString()
                });
                
                displaySocketEvent('Counter Offer Sent', {
                    requestId: requestId,
                    action: 'counter_offer',
                    newFare: counterFare,
                    driverId: currentUser.id,
                    timestamp: new Date().toISOString()
                });
                
                // Clear the fields
                document.getElementById('requestIdToRespond').value = '';
                document.getElementById('counterOfferFare').value = '';
            } else {
                alert('Please connect to Socket.IO first!');
            }
        }
        
        function rejectBookingRequest() {
            const requestId = document.getElementById('requestIdToRespond').value.trim();
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            
            if (!requestId) {
                alert('Please enter a request ID to reject!');
                return;
            }
            
            const reason = prompt('Enter rejection reason (optional):') || 'Driver declined';
            
            if (socket && isSocketConnected) {
                socket.emit('driver_response', {
                    requestId: requestId,
                    action: 'reject',
                    reason: reason,
                    driverId: currentUser.id,
                    timestamp: new Date().toISOString()
                });
                
                displaySocketEvent('Booking Request Rejected', {
                    requestId: requestId,
                    action: 'reject',
                    reason: reason,
                    driverId: currentUser.id,
                    timestamp: new Date().toISOString()
                });
                
                // Clear the request ID field
                document.getElementById('requestIdToRespond').value = '';
            } else {
                alert('Please connect to Socket.IO first!');
            }
        }
        
        function displayIncomingRequest(requestData) {
            const requestsList = document.getElementById('incomingRequestsList');
            
            // Create request element
            const requestDiv = document.createElement('div');
            requestDiv.className = 'incoming-request';
            requestDiv.style.cssText = 'border: 2px solid #007bff; padding: 15px; margin: 10px 0; border-radius: 8px; background-color: #f8f9fa; box-shadow: 0 2px 4px rgba(0,0,0,0.1);';
            
            // Calculate fare adjustment suggestions (admin-configured percentage)
            const originalFare = requestData.fare || requestData.offeredFare;
            const adjustmentPercentage = requestData.fareAdjustmentSettings?.allowedPercentage || 3; // Default to 3% if not provided
            const increaseAmount = Math.round(originalFare * (adjustmentPercentage / 100) * 100) / 100;
            const decreaseAmount = Math.round(originalFare * (adjustmentPercentage / 100) * 100) / 100;
            const suggestedIncrease = originalFare + increaseAmount;
            const suggestedDecrease = Math.max(originalFare - decreaseAmount, originalFare * 0.5); // Minimum 50% of original
            
            requestDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #ddd; padding-bottom: 10px;">
                    <div>
                        <strong style="color: #007bff;">Request ID: ${requestData.requestId}</strong>
                        <div style="font-size: 12px; color: #666; margin-top: 2px;">${new Date().toLocaleTimeString()}</div>
                    </div>
                    <span style="color: #28a745; font-weight: bold; font-size: 18px;">${originalFare} AED</span>
                </div>
                
                <div style="margin-bottom: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">
                    <div><strong>üìç From:</strong><br>${requestData.pickupLocation?.address || requestData.from?.address || 'N/A'}</div>
                    <div><strong>üìç To:</strong><br>${requestData.dropoffLocation?.address || requestData.to?.address || 'N/A'}</div>
                    <div><strong>üöó Service:</strong><br>${requestData.serviceType} - ${requestData.vehicleType}</div>
                    <div><strong>üìè Distance:</strong><br>${((requestData.distanceInMeters || requestData.distance * 1000) / 1000).toFixed(2)} km</div>
                    ${requestData.user ? `<div><strong>üë§ User:</strong><br>${requestData.user.firstName} ${requestData.user.lastName}</div>` : ''}
                    ${requestData.user?.phoneNumber ? `<div><strong>üìû Phone:</strong><br>${requestData.user.phoneNumber}</div>` : ''}
                </div>
                
                <div style="margin-bottom: 15px; padding: 10px; background-color: #e9ecef; border-radius: 5px;">
                    <div style="font-weight: bold; margin-bottom: 8px; color: #495057;">üí∞ Fare Options:</div>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="btn btn-sm" style="background-color: #dc3545; color: white; font-size: 12px;" onclick="quickCounterOffer('${requestData.requestId}', ${suggestedDecrease})">-3% (${suggestedDecrease} AED)</button>
                        <button class="btn btn-sm" style="background-color: #6c757d; color: white; font-size: 12px;" onclick="quickAccept('${requestData.requestId}')">Accept ${originalFare} AED</button>
                        <button class="btn btn-sm" style="background-color: #28a745; color: white; font-size: 12px;" onclick="quickCounterOffer('${requestData.requestId}', ${suggestedIncrease})">+3% (${suggestedIncrease} AED)</button>
                    </div>
                </div>
                
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <button class="btn btn-success btn-sm" onclick="quickAccept('${requestData.requestId}')">‚úÖ Accept</button>
                    <button class="btn btn-warning btn-sm" onclick="showCustomCounterOffer('${requestData.requestId}', ${originalFare})">üí∞ Custom Offer</button>
                    <button class="btn btn-danger btn-sm" onclick="quickReject('${requestData.requestId}')">‚ùå Reject</button>
                </div>
            `;
            
            // Remove "No incoming requests" message if it exists
            const noRequestsMsg = requestsList.querySelector('.help-text');
            if (noRequestsMsg) {
                noRequestsMsg.remove();
            }
            
            // Add new request at the top
            requestsList.insertBefore(requestDiv, requestsList.firstChild);
            
            // Keep only last 5 requests
            while (requestsList.children.length > 5) {
                requestsList.removeChild(requestsList.lastChild);
            }
            
            // Auto-remove request after 5 minutes
            setTimeout(() => {
                if (requestDiv.parentNode) {
                    requestDiv.style.opacity = '0.5';
                    requestDiv.style.border = '2px solid #dc3545';
                    const expiredLabel = document.createElement('div');
                    expiredLabel.innerHTML = '<span style="color: #dc3545; font-weight: bold;">‚è∞ EXPIRED</span>';
                    requestDiv.insertBefore(expiredLabel, requestDiv.firstChild);
                }
            }, 300000); // 5 minutes
        }
        
        function quickAccept(requestId) {
            socket.emit('driver_response', {
                action: 'accept',
                requestId: requestId,
                driverId: currentUser.id
            });
            displayRealTimeResponse('‚úÖ Booking Accepted', `Accepted booking request: ${requestId}`, 'success');
        }
        
        function quickReject(requestId) {
            const reason = prompt('Reason for rejection (optional):') || 'No reason provided';
            socket.emit('driver_response', {
                action: 'reject',
                requestId: requestId,
                driverId: currentUser.id,
                reason: reason
            });
            displayRealTimeResponse('‚ùå Booking Rejected', `Rejected booking request: ${requestId} - Reason: ${reason}`, 'error');
        }
        
        function quickCounterOffer(requestId, suggestedFare) {
            socket.emit('driver_response', {
                action: 'counter_offer',
                requestId: requestId,
                driverId: currentUser.id,
                counterFare: suggestedFare
            });
            displayRealTimeResponse('üí∞ Counter-Offer Sent', `Counter-offered ${suggestedFare} AED for request: ${requestId}`, 'warning');
        }
        
        function showCustomCounterOffer(requestId, originalFare) {
            const customFare = prompt(`Enter your counter-offer (Original: ${originalFare} AED):`);
            if (customFare && !isNaN(customFare) && parseFloat(customFare) > 0) {
                const fareValue = parseFloat(customFare);
                const minFare = originalFare * 0.5; // Minimum 50% of original
                const maxFare = originalFare * 1.5; // Maximum 150% of original
                
                if (fareValue < minFare) {
                    alert(`Fare too low! Minimum allowed: ${minFare} AED`);
                    return;
                }
                if (fareValue > maxFare) {
                    alert(`Fare too high! Maximum allowed: ${maxFare} AED`);
                    return;
                }
                
                socket.emit('driver_response', {
                    action: 'counter_offer',
                    requestId: requestId,
                    driverId: currentUser.id,
                    counterFare: fareValue
                });
                displayRealTimeResponse('üí∞ Custom Counter-Offer Sent', `Custom counter-offered ${fareValue} AED for request: ${requestId}`, 'warning');
            } else {
                alert('Please enter a valid fare amount.');
            }
        }

        // Response Display Functions
        function displayRealTimeResponse(title, data, type = 'info') {
            const responseDisplay = document.getElementById('responseDisplay');
            const responseDiv = document.createElement('div');
            responseDiv.className = `response-item ${type}`;
            responseDiv.style.cssText = `
                margin-bottom: 10px;
                padding: 10px;
                border-radius: 5px;
                border-left: 4px solid ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#007bff'};
                background-color: ${type === 'success' ? '#d4edda' : type === 'error' ? '#f8d7da' : '#d1ecf1'};
            `;
            
            // Enhanced formatting for better readability
            let formattedContent = '';
            if (typeof data === 'object' && data !== null) {
                // Special formatting for fare-related responses
                if (title.toLowerCase().includes('fare')) {
                    formattedContent = `
                        <div style="margin-bottom: 10px;">
                            ${data.requestId || data.bookingId ? `<div><strong>üìã Booking ID:</strong> ${data.requestId || data.bookingId}</div>` : ''}
                            ${data.previousFare ? `<div><strong>üí∞ Previous Fare:</strong> ${data.previousFare} AED</div>` : ''}
                            ${data.newFare ? `<div><strong>üí∞ New Fare:</strong> ${data.newFare} AED</div>` : ''}
                            ${data.fare ? `<div><strong>üí∞ Current Fare:</strong> ${data.fare} AED</div>` : ''}
                            ${data.raisedFare ? `<div><strong>üìà Raised Fare:</strong> ${data.raisedFare} AED</div>` : ''}
                            ${data.driversNotified || data.driversFound ? `<div><strong>üöó Drivers Notified:</strong> ${data.driversNotified || data.driversFound}</div>` : ''}
                            ${data.message ? `<div><strong>üìù Message:</strong> ${data.message}</div>` : ''}
                            ${data.status ? `<div><strong>üìä Status:</strong> ${data.status}</div>` : ''}
                            ${data.success !== undefined ? `<div><strong>‚úÖ Success:</strong> ${data.success}</div>` : ''}
                        </div>
                        <details style="margin-top: 10px;">
                            <summary style="cursor: pointer; font-weight: bold;">üîç View Full Response Data</summary>
                            <pre style="margin: 5px 0 0 0; white-space: pre-wrap; font-size: 11px; background: #f8f9fa; padding: 8px; border-radius: 3px;">${JSON.stringify(data, null, 2)}</pre>
                        </details>
                    `;
                } else if (title.toLowerCase().includes('booking')) {
                    formattedContent = `
                        <div style="margin-bottom: 10px;">
                            ${data.bookingId || data.requestId ? `<div><strong>üìã Booking ID:</strong> ${data.bookingId || data.requestId}</div>` : ''}
                            ${data.status ? `<div><strong>üìä Status:</strong> ${data.status}</div>` : ''}
                            ${data.fare ? `<div><strong>üí∞ Fare:</strong> ${data.fare} AED</div>` : ''}
                            ${data.serviceType ? `<div><strong>üöó Service:</strong> ${data.serviceType}</div>` : ''}
                            ${data.from ? `<div><strong>üìç From:</strong> ${typeof data.from === 'object' ? data.from.address : data.from}</div>` : ''}
                            ${data.to ? `<div><strong>üìç To:</strong> ${typeof data.to === 'object' ? data.to.address : data.to}</div>` : ''}
                            ${data.message ? `<div><strong>üìù Message:</strong> ${data.message}</div>` : ''}
                            ${data.success !== undefined ? `<div><strong>‚úÖ Success:</strong> ${data.success}</div>` : ''}
                        </div>
                        <details style="margin-top: 10px;">
                            <summary style="cursor: pointer; font-weight: bold;">üîç View Full Response Data</summary>
                            <pre style="margin: 5px 0 0 0; white-space: pre-wrap; font-size: 11px; background: #f8f9fa; padding: 8px; border-radius: 3px;">${JSON.stringify(data, null, 2)}</pre>
                        </details>
                    `;
                } else {
                    // Default formatting for other responses
                    formattedContent = `
                        <div style="margin-bottom: 10px;">
                            ${data.message ? `<div><strong>üìù Message:</strong> ${data.message}</div>` : ''}
                            ${data.success !== undefined ? `<div><strong>‚úÖ Success:</strong> ${data.success}</div>` : ''}
                            ${data.status ? `<div><strong>üìä Status:</strong> ${data.status}</div>` : ''}
                            ${data.error ? `<div><strong>‚ùå Error:</strong> ${data.error}</div>` : ''}
                        </div>
                        <details style="margin-top: 10px;">
                            <summary style="cursor: pointer; font-weight: bold;">üîç View Full Response Data</summary>
                            <pre style="margin: 5px 0 0 0; white-space: pre-wrap; font-size: 11px; background: #f8f9fa; padding: 8px; border-radius: 3px;">${JSON.stringify(data, null, 2)}</pre>
                        </details>
                    `;
                }
            } else {
                formattedContent = `<pre style="margin: 0; white-space: pre-wrap; font-size: 12px;">${data}</pre>`;
            }
            
            responseDiv.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 5px;">${title}</div>
                <div style="font-size: 12px; color: #666; margin-bottom: 5px;">${new Date().toLocaleTimeString()}</div>
                ${formattedContent}
            `;
            
            responseDisplay.insertBefore(responseDiv, responseDisplay.firstChild);
            
            // Keep only last 15 responses for better monitoring
            while (responseDisplay.children.length > 15) {
                responseDisplay.removeChild(responseDisplay.lastChild);
            }
        }
        
        function clearResponseDisplay() {
            document.getElementById('responseDisplay').innerHTML = '';
        }
        
        function getBookingStatus() {
            const bookingId = currentBookingId || document.getElementById('testBookingId').value;
            if (!bookingId) {
                alert('Please enter a booking ID or create a booking first!');
                return;
            }
            
            displayRealTimeResponse('Checking Booking Status', { bookingId: bookingId }, 'info');
        }
        
        function getFareHistory() {
            const bookingId = currentBookingId || document.getElementById('testBookingId').value;
            if (!bookingId) {
                alert('Please enter a booking ID or create a booking first!');
                return;
            }
            
            displayRealTimeResponse('Getting Fare History', { bookingId: bookingId }, 'info');
        }
        
        // REST API Testing Functions
        async function testGetBookingAPI() {
            const bookingId = document.getElementById('testBookingId').value || currentBookingId;
            if (!bookingId) {
                alert('Please enter a booking ID!');
                return;
            }
            
            const token = localStorage.getItem('authToken');
            if (!token) {
                alert('Please login first!');
                return;
            }
            
            try {
                displayRealTimeResponse('API Request: GET Booking Details', { bookingId: bookingId, endpoint: `/api/bookings/${bookingId}` }, 'info');
                
                const response = await fetch(`/api/bookings/${bookingId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                displayRealTimeResponse('API Response: GET Booking Details', {
                    status: response.status,
                    success: response.ok,
                    data: data
                }, response.ok ? 'success' : 'error');
                
            } catch (error) {
                displayRealTimeResponse('API Error: GET Booking Details', {
                    error: error.message
                }, 'error');
            }
        }
        
        async function testUpdateFareAPI() {
            const bookingId = document.getElementById('testBookingId').value || currentBookingId;
            if (!bookingId) {
                alert('Please enter a booking ID!');
                return;
            }
            
            const newFare = prompt('Enter new fare amount:');
            if (!newFare || isNaN(newFare)) {
                alert('Please enter a valid fare amount!');
                return;
            }
            
            const token = localStorage.getItem('authToken');
            if (!token) {
                alert('Please login first!');
                return;
            }
            
            try {
                displayRealTimeResponse('API Request: PUT Update Fare', {
                    bookingId: bookingId,
                    newFare: parseFloat(newFare),
                    endpoint: `/api/bookings/${bookingId}/fare`
                }, 'info');
                
                const response = await fetch(`/api/bookings/${bookingId}/fare`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        newFare: parseFloat(newFare)
                    })
                });
                
                const data = await response.json();
                displayRealTimeResponse('API Response: PUT Update Fare', {
                    status: response.status,
                    success: response.ok,
                    data: data
                }, response.ok ? 'success' : 'error');
                
            } catch (error) {
                displayRealTimeResponse('API Error: PUT Update Fare', {
                    error: error.message
                }, 'error');
            }
        }
        
        async function testGetFareHistoryAPI() {
            const bookingId = document.getElementById('testBookingId').value || currentBookingId;
            if (!bookingId) {
                alert('Please enter a booking ID!');
                return;
            }
            
            const token = localStorage.getItem('authToken');
            if (!token) {
                alert('Please login first!');
                return;
            }
            
            try {
                displayRealTimeResponse('API Request: GET Fare History', {
                    bookingId: bookingId,
                    endpoint: `/api/bookings/${bookingId}/fare-history`
                }, 'info');
                
                const response = await fetch(`/api/bookings/${bookingId}/fare-history`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                displayRealTimeResponse('API Response: GET Fare History', {
                    status: response.status,
                    success: response.ok,
                    data: data
                }, response.ok ? 'success' : 'error');
                
            } catch (error) {
                displayRealTimeResponse('API Error: GET Fare History', {
                    error: error.message
                }, 'error');
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            updateVehicleTypes();
            
            // Initialize authToken from localStorage
            const token = localStorage.getItem('authToken');
            if (token) {
                authToken = token;
                
                // Show user status if user data exists
                const userData = localStorage.getItem('currentUser');
                if (userData) {
                    try {
                        const user = JSON.parse(userData);
                        showUserStatus(user);
                    } catch (e) {
                        console.error('Error parsing user data:', e);
                    }
                }
                
                // Auto-connect socket
                setTimeout(() => {
                    initializeSocket();
                }, 1000);
            }
            
            // Request notification permission for driver alerts
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        });
    </script>
    
    <!-- Socket.IO Client Library -->
    <script src="/socket.io/socket.io.js"></script>
</body>
</html>