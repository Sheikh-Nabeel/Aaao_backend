<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöó Driver Interface - Real-Time Booking System</title>
    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; color: white; margin-bottom: 30px; }
        .card { background: white; border-radius: 15px; padding: 25px; margin: 20px 0; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .status-card { background: linear-gradient(45deg, #ff6b6b, #ee5a24); color: white; }
        .status-card.online { background: linear-gradient(45deg, #00d2d3, #54a0ff); }
        .input-group { margin: 15px 0; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        input, select, textarea { width: 100%; padding: 12px; border: 2px solid #e1e8ed; border-radius: 8px; font-size: 14px; transition: border-color 0.3s; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #667eea; }
        button { padding: 12px 25px; margin: 8px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        button:hover { background: #5a67d8; transform: translateY(-2px); }
        button:disabled { background: #cbd5e0; cursor: not-allowed; transform: none; }
        button.success { background: #48bb78; }
        button.danger { background: #f56565; }
        button.warning { background: #ed8936; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .full-width { grid-column: 1 / -1; }
        .log { background: #f7fafc; border: 2px solid #e2e8f0; padding: 20px; height: 350px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 13px; border-radius: 8px; }
        .error { color: #e53e3e; font-weight: bold; }
        .success { color: #38a169; font-weight: bold; }
        .info { color: #3182ce; }
        .warning { color: #d69e2e; }
        .timestamp { color: #718096; font-size: 11px; }
        .booking-request { background: #fff5f5; border: 2px solid #feb2b2; padding: 15px; margin: 10px 0; border-radius: 8px; }
        .booking-request.new { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .ride-info { background: #f0fff4; border: 2px solid #9ae6b4; padding: 15px; margin: 10px 0; border-radius: 8px; }
        .location-display { background: #edf2f7; padding: 10px; border-radius: 6px; margin: 5px 0; font-family: monospace; }
        .auto-accept-settings { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; border: 2px solid #e9ecef; }
        .preference-group { background: #f8f9fa; padding: 15px; border-radius: 8px; }
        .preference-group h4 { color: #495057; margin-bottom: 15px; }
        .pink-captain-options { background: #fce4ec; padding: 10px; border-radius: 6px; margin-top: 10px; border: 1px solid #f8bbd9; }
        input[type="checkbox"] { margin-right: 8px; transform: scale(1.2); }
        label { display: flex; align-items: center; cursor: pointer; }
        label:hover { background: #f1f3f4; padding: 5px; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöó Driver Interface</h1>
            <p>Real-Time Booking System - Driver Dashboard</p>
        </div>

        <!-- Connection Status -->
        <div class="card status-card" id="statusCard">
            <h2>üîå Connection Status</h2>
            <p id="connectionStatus">Disconnected</p>
            <div class="input-group">
                <label for="driverToken">Driver JWT Token:</label>
                <input type="text" id="driverToken" placeholder="Enter driver JWT token">
            </div>
            <button id="connectBtn" onclick="connectDriver()">Connect as Driver</button>
            <button id="disconnectBtn" onclick="disconnectDriver()" disabled>Disconnect</button>
        </div>

        <div class="grid">
            <!-- Driver Status Management -->
            <div class="card">
                <h3>üìç Driver Status & Location</h3>
                <div class="input-group">
                    <label for="driverStatus">Status:</label>
                    <select id="driverStatus" onchange="updateDriverStatus()">
                        <option value="offline">Offline</option>
                        <option value="online">Online</option>
                        <option value="busy">Busy</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="driverLat">Latitude:</label>
                    <input type="number" id="driverLat" step="0.000001" placeholder="24.8607" value="24.8607">
                </div>
                <div class="input-group">
                    <label for="driverLng">Longitude:</label>
                    <input type="number" id="driverLng" step="0.000001" placeholder="67.0011" value="67.0011">
                </div>
                <button onclick="updateDriverLocation()">Update Location</button>
                <button onclick="getLocation()">Get My Location</button>
                
                <!-- Auto Accept Settings -->
                <div class="auto-accept-settings" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
                    <h4>ü§ñ Auto Accept Settings</h4>
                    <div class="input-group">
                        <label>
                            <input type="checkbox" id="autoAcceptEnabled"> Enable Auto Accept
                        </label>
                    </div>
                    <div class="input-group">
                        <label for="minFareAmount">Minimum Fare (PKR):</label>
                        <input type="number" id="minFareAmount" value="100" placeholder="100">
                    </div>
                    <button onclick="updateAutoAcceptSettings()">ü§ñ Update Auto Accept</button>
                </div>
            </div>

            <!-- Ride Type Preferences -->
            <div class="card">
                <h3>üéØ Ride Type Preferences</h3>
                <div class="preference-group">
                    <h4>Select which ride types to receive:</h4>
                    <div class="input-group">
                        <label>
                            <input type="checkbox" id="acceptBike" checked> üèçÔ∏è Bike Rides
                        </label>
                    </div>
                    <div class="input-group">
                        <label>
                            <input type="checkbox" id="acceptRickshaw" checked> üõ∫ Rickshaw Rides
                        </label>
                    </div>
                    <div class="input-group">
                        <label>
                            <input type="checkbox" id="acceptCar" checked> üöó Car Rides
                        </label>
                    </div>
                    <div class="input-group">
                        <label>
                            <input type="checkbox" id="acceptMini" checked> üöô Mini Rides
                        </label>
                    </div>
                    
                    <h4 style="margin-top: 20px;">üíñ Pink Captain Preferences:</h4>
                    <div class="input-group">
                        <label>
                            <input type="checkbox" id="pinkCaptainMode" onchange="togglePinkCaptainOptions()"> Enable Pink Captain Mode
                        </label>
                    </div>
                    <div class="pink-captain-options" id="pinkCaptainOptions" style="display: none; margin-left: 20px; padding: 10px; border-left: 3px solid #ff69b4; background-color: #fdf2f8;">
                        <p style="margin: 0 0 10px 0; font-size: 12px; color: #666;">Select the types of Pink Captain rides you want to accept:</p>
                        <div class="input-group">
                            <label>
                                <input type="checkbox" id="acceptFemaleOnly"> üë© Female Passengers Only
                            </label>
                            <small style="display: block; color: #666; margin-left: 20px;">Accept rides with only female passengers</small>
                        </div>
                        <div class="input-group">
                            <label>
                                <input type="checkbox" id="acceptFamilyRides"> üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family Rides
                            </label>
                            <small style="display: block; color: #666; margin-left: 20px;">Accept family trips with children</small>
                        </div>
                        <div class="input-group">
                            <label>
                                <input type="checkbox" id="acceptSafeRides"> üõ°Ô∏è Safe Zone Rides
                            </label>
                            <small style="display: block; color: #666; margin-left: 20px;">Accept rides in designated safe areas</small>
                        </div>
                    </div>
                    
                    <button onclick="updateRidePreferences()">üéØ Update Preferences</button>
                </div>
            </div>
        </div>

        <!-- Booking Requests -->
        <div class="card">
            <h3>üìã Incoming Booking Requests</h3>
            <div id="bookingRequests"></div>
            <button onclick="clearBookingRequests()">Clear All Requests</button>
        </div>

        <!-- Active Ride Management -->
        <div class="card full-width">
            <h3>üöô Active Ride Management</h3>
            <div class="grid">
                <div>
                    <div class="input-group">
                        <label for="activeBookingId">Active Booking ID:</label>
                        <input type="text" id="activeBookingId" placeholder="Booking ID will appear here" readonly>
                    </div>
                    <div id="activeRideInfo"></div>
                </div>
                <div>
                    <h4>Ride Actions:</h4>
                    <button class="success" onclick="startRide()" id="startRideBtn" disabled>Start Ride</button>
                    <button class="warning" onclick="completeRide()" id="completeRideBtn" disabled>Complete Ride</button>
                    <button class="danger" onclick="cancelRide()" id="cancelRideBtn" disabled>Cancel Ride</button>
                    <br><br>
                    <h4>Fare Management:</h4>
                    <div class="input-group">
                        <label for="newFare">Propose New Fare:</label>
                        <input type="number" id="newFare" placeholder="Enter new fare amount">
                    </div>
                    <button onclick="increaseFare()" id="increaseFareBtn" disabled>Propose Fare Increase</button>
                </div>
            </div>
        </div>

        <!-- Communication -->
        <div class="card">
            <h3>üí¨ Ride Communication</h3>
            <div class="input-group">
                <label for="messageText">Message to User:</label>
                <textarea id="messageText" rows="3" placeholder="Type your message to the user..."></textarea>
            </div>
            <button onclick="sendMessage()" id="sendMessageBtn" disabled>Send Message</button>
        </div>

        <!-- Event Log -->
        <div class="card full-width">
            <h3>üìä Real-Time Event Log</h3>
            <button onclick="clearLog()">Clear Log</button>
            <div class="log" id="eventLog"></div>
        </div>
    </div>

    <script>
        let socket = null;
        let currentBookingId = null;
        let bookingRequests = [];

        function log(message, type = 'info') {
            const logDiv = document.getElementById('eventLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span class="timestamp">[${timestamp}]</span> <span class="${type}">${message}</span>`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('eventLog').innerHTML = '';
        }

        function connectDriver() {
            const token = document.getElementById('driverToken').value;
            if (!token) {
                log('‚ùå Please enter a JWT token', 'error');
                return;
            }

            socket = io('http://localhost:3001', {
                auth: { token: token }
            });

            socket.on('connect', () => {
                log('‚úÖ Connected to server as driver', 'success');
                document.getElementById('connectionStatus').textContent = 'Connected as Driver';
                document.getElementById('statusCard').classList.add('online');
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('disconnectBtn').disabled = false;
                
                // Join driver room
                const userId = parseJWT(token)._id;
                socket.emit('join_driver_room', userId);
            });

            socket.on('disconnect', () => {
                log('‚ùå Disconnected from server', 'error');
                document.getElementById('connectionStatus').textContent = 'Disconnected';
                document.getElementById('statusCard').classList.remove('online');
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = true;
            });

            socket.on('connect_error', (error) => {
                log(`‚ùå Connection error: ${error.message}`, 'error');
            });

            socket.on('room_joined', (data) => {
                log(`üè† Joined room: ${data.room}`, 'success');
            });

            socket.on('new_booking_request', (data) => {
                log(`üîî New booking request received: ${data.booking._id}`, 'warning');
                
                // Check auto-accept first
                if (!checkAutoAccept(data)) {
                    displayBookingRequest(data);
                }
            });

            socket.on('booking_accepted', (data) => {
                log(`‚úÖ Booking accepted: ${data.bookingId}`, 'success');
                currentBookingId = data.bookingId;
                document.getElementById('activeBookingId').value = currentBookingId;
                enableRideControls();
                displayActiveRide(data);
            });

            socket.on('ride_started', (data) => {
                log(`üöó Ride started: ${data.bookingId}`, 'success');
                document.getElementById('startRideBtn').disabled = true;
                document.getElementById('completeRideBtn').disabled = false;
            });

            socket.on('ride_completed', (data) => {
                log(`üèÅ Ride completed: ${data.bookingId}`, 'success');
                log(`üí∞ Payment: ${data.payment?.amount || 'N/A'} ${data.payment?.method || ''}`, 'info');
                resetRideControls();
            });

            socket.on('ride_cancelled', (data) => {
                log(`‚ùå Ride cancelled: ${data.bookingId}`, 'warning');
                resetRideControls();
            });

            socket.on('fare_adjustment', (data) => {
                log(`üí∞ Fare adjusted to: ${data.newFare}`, 'info');
            });

            socket.on('fare_increase_accepted', (data) => {
                log(`‚úÖ Fare increase accepted: ${data.newFare}`, 'success');
            });

            socket.on('ride_message', (data) => {
                log(`üí¨ Message from user: ${data.message}`, 'info');
            });

            socket.on('error', (data) => {
                log(`‚ùå Error: ${data.message}`, 'error');
            });
        }

        function disconnectDriver() {
            if (socket) {
                socket.disconnect();
                socket = null;
            }
        }

        function updateDriverStatus() {
            if (!socket) return;
            
            const status = document.getElementById('driverStatus').value;
            const lat = parseFloat(document.getElementById('driverLat').value);
            const lng = parseFloat(document.getElementById('driverLng').value);
            
            socket.emit('driver_status_update', {
                status: status,
                location: { latitude: lat, longitude: lng }
            });
            
            log(`üìç Status updated: ${status} at [${lat}, ${lng}]`, 'info');
        }

        function updateDriverLocation() {
            if (!socket) return;
            
            const lat = parseFloat(document.getElementById('driverLat').value);
            const lng = parseFloat(document.getElementById('driverLng').value);
            
            socket.emit('driver_location_update', {
                latitude: lat,
                longitude: lng
            });
            
            log(`üìç Location updated: [${lat}, ${lng}]`, 'info');
        }

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    document.getElementById('driverLat').value = position.coords.latitude;
                    document.getElementById('driverLng').value = position.coords.longitude;
                    log(`üìç Location obtained: [${position.coords.latitude}, ${position.coords.longitude}]`, 'success');
                });
            } else {
                log('‚ùå Geolocation not supported', 'error');
            }
        }

        function displayBookingRequest(data) {
            const container = document.getElementById('bookingRequests');
            const requestDiv = document.createElement('div');
            requestDiv.className = 'booking-request new';
            requestDiv.innerHTML = `
                <h4>üîî Booking Request: ${data.booking._id}</h4>
                <p><strong>From:</strong> ${data.booking.pickupLocation.address}</p>
                <p><strong>To:</strong> ${data.booking.dropoffLocation.address}</p>
                <p><strong>Service:</strong> ${data.booking.serviceType}</p>
                <p><strong>Fare:</strong> ${data.booking.estimatedFare}</p>
                <p><strong>Distance:</strong> ${data.booking.distanceInMeters}m</p>
                <button class="success" onclick="acceptBooking('${data.booking._id}')">Accept</button>
                <button class="danger" onclick="rejectBooking('${data.booking._id}')">Reject</button>
            `;
            container.appendChild(requestDiv);
            bookingRequests.push(data.booking._id);
        }

        function acceptBooking(bookingId) {
            if (!socket) return;
            socket.emit('accept_booking_request', { bookingId });
            log(`‚úÖ Accepting booking: ${bookingId}`, 'info');
        }

        function rejectBooking(bookingId) {
            if (!socket) return;
            socket.emit('reject_booking_request', { 
                bookingId, 
                reason: 'Driver not available' 
            });
            log(`‚ùå Rejecting booking: ${bookingId}`, 'warning');
            removeBookingRequest(bookingId);
        }

        function removeBookingRequest(bookingId) {
            const container = document.getElementById('bookingRequests');
            const requests = container.children;
            for (let i = 0; i < requests.length; i++) {
                if (requests[i].innerHTML.includes(bookingId)) {
                    container.removeChild(requests[i]);
                    break;
                }
            }
        }

        function clearBookingRequests() {
            document.getElementById('bookingRequests').innerHTML = '';
            bookingRequests = [];
        }

        function displayActiveRide(data) {
            const container = document.getElementById('activeRideInfo');
            container.innerHTML = `
                <div class="ride-info">
                    <h4>üöô Active Ride</h4>
                    <p><strong>Booking ID:</strong> ${data.bookingId}</p>
                    <p><strong>Status:</strong> ${data.status || 'Accepted'}</p>
                    <div class="location-display">
                        <strong>Pickup:</strong> ${data.pickup || 'Loading...'}
                    </div>
                    <div class="location-display">
                        <strong>Dropoff:</strong> ${data.dropoff || 'Loading...'}
                    </div>
                </div>
            `;
        }

        function enableRideControls() {
            document.getElementById('startRideBtn').disabled = false;
            document.getElementById('cancelRideBtn').disabled = false;
            document.getElementById('increaseFareBtn').disabled = false;
            document.getElementById('sendMessageBtn').disabled = false;
        }

        function resetRideControls() {
            document.getElementById('startRideBtn').disabled = true;
            document.getElementById('completeRideBtn').disabled = true;
            document.getElementById('cancelRideBtn').disabled = true;
            document.getElementById('increaseFareBtn').disabled = true;
            document.getElementById('sendMessageBtn').disabled = true;
            document.getElementById('activeBookingId').value = '';
            document.getElementById('activeRideInfo').innerHTML = '';
            currentBookingId = null;
        }

        function startRide() {
            if (!socket || !currentBookingId) return;
            socket.emit('start_ride', { bookingId: currentBookingId });
            log(`üöó Starting ride: ${currentBookingId}`, 'info');
        }

        function completeRide() {
            if (!socket || !currentBookingId) return;
            socket.emit('complete_ride', { bookingId: currentBookingId });
            log(`üèÅ Completing ride: ${currentBookingId}`, 'info');
        }

        function cancelRide() {
            if (!socket || !currentBookingId) return;
            socket.emit('cancel_ride', { 
                bookingId: currentBookingId,
                reason: 'Driver cancelled'
            });
            log(`‚ùå Cancelling ride: ${currentBookingId}`, 'warning');
        }

        function increaseFare() {
            if (!socket || !currentBookingId) return;
            const newFare = parseFloat(document.getElementById('newFare').value);
            if (!newFare) {
                log('‚ùå Please enter a valid fare amount', 'error');
                return;
            }
            socket.emit('increase_fare', { 
                bookingId: currentBookingId,
                raisedFare: newFare
            });
            log(`üí∞ Proposing fare increase to: ${newFare}`, 'info');
        }

        function sendMessage() {
            if (!socket || !currentBookingId) return;
            const message = document.getElementById('messageText').value;
            if (!message) {
                log('‚ùå Please enter a message', 'error');
                return;
            }
            socket.emit('send_ride_message', {
                bookingId: currentBookingId,
                message: message
            });
            log(`üí¨ Message sent: ${message}`, 'info');
            document.getElementById('messageText').value = '';
        }

        function parseJWT(token) {
            try {
                return JSON.parse(atob(token.split('.')[1]));
            } catch (e) {
                return {};
            }
        }

        // Auto Accept Settings
        let autoAcceptSettings = {
            enabled: false,
            minFare: 100
        };

        function updateAutoAcceptSettings() {
            autoAcceptSettings.enabled = document.getElementById('autoAcceptEnabled').checked;
            autoAcceptSettings.minFare = parseFloat(document.getElementById('minFareAmount').value) || 100;
            
            if (socket) {
                socket.emit('update_auto_accept_settings', autoAcceptSettings);
            }
            
            log(`ü§ñ Auto Accept ${autoAcceptSettings.enabled ? 'enabled' : 'disabled'} with min fare: ${autoAcceptSettings.minFare}`, 'info');
        }

        function updateRidePreferences() {
            const preferences = {
                acceptBike: document.getElementById('acceptBike').checked,
                acceptRickshaw: document.getElementById('acceptRickshaw').checked,
                acceptCar: document.getElementById('acceptCar').checked,
                acceptMini: document.getElementById('acceptMini').checked,
                pinkCaptainMode: document.getElementById('pinkCaptainMode').checked,
                acceptFemaleOnly: document.getElementById('acceptFemaleOnly').checked,
                acceptFamilyRides: document.getElementById('acceptFamilyRides').checked,
                acceptSafeRides: document.getElementById('acceptSafeRides').checked
            };
            
            if (socket) {
                socket.emit('update_ride_preferences', preferences);
            }
            
            log(`üéØ Ride preferences updated`, 'info');
        }

        function togglePinkCaptainOptions() {
            const pinkCaptainMode = document.getElementById('pinkCaptainMode').checked;
            const options = document.getElementById('pinkCaptainOptions');
            options.style.display = pinkCaptainMode ? 'block' : 'none';
        }

        // Auto-update location every 30 seconds when online
        setInterval(() => {
            if (socket && document.getElementById('driverStatus').value === 'online') {
                updateDriverLocation();
            }
        }, 30000);

        // Auto accept functionality
        function checkAutoAccept(bookingData) {
            if (!autoAcceptSettings.enabled) return false;
            
            const fare = parseFloat(bookingData.booking.estimatedFare);
            if (fare >= autoAcceptSettings.minFare) {
                log(`ü§ñ Auto accepting booking: ${bookingData.booking._id} (Fare: ${fare})`, 'success');
                acceptBooking(bookingData.booking._id);
                return true;
            }
            
            log(`ü§ñ Auto reject: Fare ${fare} below minimum ${autoAcceptSettings.minFare}`, 'warning');
            return false;
        }
    </script>
</body>
</html>